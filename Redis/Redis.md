#  Redis

## ğŸ˜Š å¤ä¹ 

> 8å¤§æ•°æ®ç±»å‹

stringã€hashã€listã€setã€sortedSetã€Bitmapã€HyperLogLogã€GEO

> Stringç±»å‹ä½¿ç”¨åœºæ™¯

**1ã€å‘½ä»¤**

æœ€å¸¸ç”¨ï¼š`set key value`ã€`get key`

è®¾ç½®å¤šä¸ªï¼š`mset k1 v1 k2 v2`ã€`mget k1 k2`

æ•°å€¼å¢å‡ï¼š

- é€’å¢ï¼š`incr k1`
- å¢åŠ æŒ‡å®šï¼š`incrby k1 2`
- é€’å‡ï¼š`decr k1`
- å‡å°‘æŒ‡å®šï¼š`decrby k1 2`

è·å–å­—ç¬¦ä¸²é•¿åº¦ï¼š`strlen k1`

`setnx k1 v1`ã€`set key value [EX seconds][PX milliseconds] [NX|XX]`ã€`setex key seconds value`

- EXï¼škeyåœ¨å¤šå°‘ç§’åè¿‡æœŸ
- PXï¼škeyåœ¨å¤šå°‘æ¯«ç§’åè¿‡æœŸ

- NXï¼šå½“keyä¸å­˜åœ¨æ—¶ï¼Œæ‰åˆ›å»ºkeyï¼Œæ•ˆæœç­‰åŒäºsetnx
- XXï¼šå½“keyå­˜åœ¨æ—¶ï¼Œè¦†ç›–key

**2ã€åº”ç”¨åœºæ™¯**

- å•†å“ç¼–å·ã€è®¢å•å·é‡‡ç”¨incrå‘½ä»¤ç”Ÿæˆ



> hashåº”ç”¨åœºæ™¯

`Map<String,Map<Object,Object>>`

**1ã€å‘½ä»¤**

ä¸€æ¬¡è®¾ç½®ä¸€ä¸ªå­—æ®µå€¼ï¼š`hset k1 f1 v1`

ä¸€æ¬¡è·å–ä¸€ä¸ªå­—æ®µå€¼ï¼š`hget k1 f1`

ä¸€æ¬¡è®¾ç½®å¤šä¸ªå­—æ®µå€¼ï¼š`hmset k1 f1 v1 f2 v2`

ä¸€æ¬¡è·å–å¤šä¸ªå­—æ®µå€¼ï¼š`hmget k1 f1 f2`

è·å–æ‰€æœ‰å­—æ®µå€¼ï¼š`hgetall k1`

è·å–æŸä¸ªkeyå†…å…¨éƒ¨æ•°é‡ï¼š`hlen k1`

åˆ é™¤ä¸€ä¸ªkeyï¼š`hdel k1`

å¢åŠ ï¼š`hincrby k1 f1 2`

**2ã€åº”ç”¨åœºæ™¯**

- è´­ç‰©è½¦

> liståº”ç”¨åœºæ™¯

**1ã€å‘½ä»¤**

å·¦è¾¹æ·»åŠ ï¼š`lpush k1 1 2 3 4` 

å³è¾¹æ·»åŠ ï¼š`rpush k1 1 2 3 4`

æŸ¥çœ‹åˆ—è¡¨ï¼ˆç±»ä¼¼äºåˆ†é¡µï¼‰ï¼š`lrange k1 0 -1`

è·å–å…ƒç´ ä¸ªæ•°ï¼š`llen k1`

**2ã€åº”ç”¨åœºæ™¯**

- ç‚¹èµ

> setåº”ç”¨åœºæ™¯

**1ã€å‘½ä»¤**

æ·»åŠ å…ƒç´ ï¼š`sadd k1 m1 m2...`

åˆ é™¤å…ƒç´ ï¼š`srem k1 m1 m2...`

è·å–é›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ ï¼š`smembers k1`

åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ï¼š`sismember k1 m1`

è·å–é›†åˆä¸­å…ƒç´ çš„ä¸ªæ•°ï¼š`scard k1`

ä»é›†åˆä¸­éšæœºå¼¹å‡ºä¸€ä¸ªå…ƒç´ ï¼Œå…ƒç´ ä¸åˆ é™¤ï¼š`srandmember k1 [æ•°å­—]`

ä»é›†åˆä¸­éšæœºå¼¹å‡ºä¸€ä¸ªå…ƒç´ ï¼Œå‡ºä¸€ä¸ªåˆ ä¸€ä¸ªï¼š`spop k1 [æ•°å­—]`

**2ã€é›†åˆè¿ç®—**

äº¤ï¼š`sinter key1 key2`

å¹¶ï¼š`sunion key1 key2`

å·®ï¼ˆå±äºk1ä¸å±äºk2ï¼‰ï¼š`sdiff key1 key2`

**3ã€åº”ç”¨åœºæ™¯**

- å¾®ä¿¡æŠ½å¥–å°ç¨‹åº

  - å‚ä¸ï¼š`sadd key ç”¨æˆ·ID`

  - æ˜¾ç¤ºå‚ä¸äººæ•°ï¼š`scard key`
  - æŠ½å¥–ï¼š`spop k1 1`

- æœ‹å‹åœˆç‚¹èµ

  - æ–°å¢ç‚¹èµï¼š`sadd pub:msgID ç‚¹èµç”¨æˆ·1 ç‚¹èµç”¨æˆ·2 `
  - å–æ¶ˆç‚¹èµï¼š`srem pub:msgID ç‚¹èµç”¨æˆ·1`
  - å±•ç¤ºæ‰€æœ‰ç‚¹èµè¿‡çš„ç”¨æˆ·ï¼š`smembers pub:msgID`
  - ç‚¹èµç”¨æˆ·ç»Ÿè®¡ï¼š`scard pub:msgID`

- å¥½å‹ç¤¾äº¤å…³ç³»
  - å…±åŒå…³æ³¨ï¼š`sinter s1 s2`
- qqå¯èƒ½è®¤è¯†çš„äºº
  - `sdiff s1 s2`

> zsetåº”ç”¨åœºæ™¯

å‘æœ‰åºé›†åˆä¸­åŠ å…¥å…ƒç´ å’Œåˆ†æ•°

**1ã€å‘½ä»¤**

æ·»åŠ å…ƒç´ ï¼š`zadd k1 score m1`

æŒ‰ç…§å…ƒç´ åˆ†æ•°ä»å°åˆ°å¤§é¡ºåºè¿”å›ç´¢å¼•ä»startåˆ°stopä¹‹é—´çš„æ‰€æœ‰å…ƒç´ ï¼š`zrange k1 start stop [withscores]`

è·å–å…ƒç´ çš„åˆ†æ•°ï¼š`zscore k1 m1`

è·å–æ’åï¼š`zrank k1 m1`ã€`zrevrank k1 m1`

å¢åŠ ï¼š`zincrby key 1 m1`

**2ã€åœºæ™¯**

- çƒ­æœ

- æ’åºæ˜¾ç¤º

> åˆ†å¸ƒå¼é”



















## ğŸ˜Š å…¥é—¨

**é—®é¢˜ç°è±¡**

- æµ·é‡ç”¨æˆ·
- é«˜å¹¶å‘

**å…³ç³»å‹æ•°æ®åº“**

- æ€§èƒ½ç“¶é¢ˆï¼šç£ç›˜IOæ€§èƒ½ä½ä¸‹
- æ‰©å±•ç“¶é¢ˆï¼šæ•°æ®å…³ç³»å¤æ‚ã€æ‰©å±•æ€§å·®ã€ä¸ä¾¿äºå¤§è§„æ¨¡é›†ç¾¤

**è§£å†³æ€è·¯**

- é™ä½ç£ç›˜IOæ¬¡æ•°
- å»é™¤æ•°æ®é—´å…³ç³»ï¼Œè¶Šç®€å•è¶Šå¥½

### Nosql

1ã€Nosqlï¼šéå…³ç³»å‹æ•°æ®åº“ï¼Œä½œä¸ºå…³ç³»å‹æ•°æ®åº“çš„è¡¥å……

2ã€**ä½œç”¨ï¼š**åº”å¯¹åŸºäºæµ·é‡ç”¨æˆ·å’Œæµ·é‡æ•°æ®å‰æä¸‹çš„æ•°æ®å¤„ç†é—®é¢˜

3ã€ç‰¹å¾ï¼š

- å¯æ‰©å®¹ã€å¯ä¼¸ç¼©
- å¤§æ•°æ®é‡ä¸‹é«˜æ€§èƒ½
- çµæ´»çš„æ•°æ®æ¨¡å‹
- é«˜å¯ç”¨
- **ä¸æ”¯æŒACID**

**4ã€å¸¸è§Nosqlæ•°æ®åº“ï¼š**

- Redis
  - æ•°æ®åœ¨å†…å­˜ï¼Œæ”¯æŒæŒä¹…åŒ–
  - æ”¯æŒå¤šç§æ•°æ®ç»“æ„çš„å­˜å‚¨
- memcache
  - æ•°æ®åœ¨å†…å­˜ï¼Œä¸æ”¯æŒæŒä¹…åŒ–
- MongoDB
  - æ–‡æ¡£å‹æ•°æ®åº“
  - å¯¹valueï¼ˆå°¤å…¶æ˜¯jsonï¼‰æä¾›ä¸°å¯Œçš„æŸ¥è¯¢åŠŸèƒ½

### Redisç®€ä»‹

æ¦‚å¿µï¼šç”¨Cè¯­è¨€å¼€å‘çš„ä¸€ä¸ªå¼€æºçš„é«˜æ€§èƒ½**é”®å€¼å¯¹æ•°æ®åº“**

ç‰¹å¾ï¼š

- æ•°æ®é—´æ²¡æœ‰å¿…ç„¶çš„å…³è”å…³ç³»
- å†…éƒ¨ä½¿ç”¨**å•çº¿ç¨‹**
- é«˜æ€§èƒ½
- å¤šæ•°æ®ç±»å‹æ”¯æŒ
  - å­—ç¬¦ä¸²ç±»å‹ string
  - åˆ—è¡¨ç±»å‹ list
  - æ•£åˆ—ç±»å‹ hash
  - é›†åˆç±»å‹ set
  - æœ‰åºé›†åˆç±»å‹ zset
- æ•°æ®ç±»å‹éƒ½æ”¯æŒä¸°å¯Œæ“ä½œï¼Œä¸”æ˜¯**åŸå­æ€§**çš„
- æŒä¹…åŒ–æ”¯æŒï¼Œå¯ä»¥è¿›è¡Œæ•°æ®ç¾éš¾æ¢å¤
- å®ç°ä¸»ä»åŒæ­¥æ“ä½œ

### Redisåº”ç”¨

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/084e21ceb94244d787ff17b4f2a8c438.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

### Rediså®‰è£…

```bash
redis-benchmarkï¼šæ€§èƒ½æµ‹è¯•å·¥å…·
redis-check-aof ï¼šä¿®å¤æœ‰é—®é¢˜çš„AOFæ–‡ä»¶
redis-check-rdbï¼šä¿®å¤æœ‰é—®é¢˜çš„RDBæ–‡ä»¶
redis-sentinelï¼šRedisé›†ç¾¤ä½¿ç”¨

redis-serverï¼šRedisæœåŠ¡å™¨å¯åŠ¨å‘½ä»¤
redis-cliï¼šå®¢æˆ·ç«¯ï¼Œæ“ä½œå…¥å£
```

å¯åŠ¨ï¼š

```bash
redis-server
```

### Redisç›¸å…³çŸ¥è¯†

1ã€ç«¯å£ï¼š6379

2ã€é»˜è®¤16ä¸ªæ•°æ®åº“ï¼Œselect 0/1/2

3ã€Redisæ˜¯ **å•çº¿ç¨‹+å¤šè·¯IOå¤ç”¨æŠ€æœ¯**

- **å¤šè·¯å¤ç”¨**ï¼šä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ£€æŸ¥å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆsocketï¼‰çš„å°±ç»ªçŠ¶æ€ï¼Œæ¯”å¦‚è°ƒç”¨selectå’Œpollå‡½æ•°ï¼Œä¼ å…¥å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼Œåˆ™è¿”å›ï¼Œå¦åˆ™é˜»å¡ç›´åˆ°è¶…æ—¶ã€‚å¾—åˆ°å°±ç»ªçŠ¶æ€åè¿›è¡ŒçœŸæ­£çš„æ“ä½œå¯ä»¥åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å¯ç”¨çº¿ç¨‹æ‰§è¡Œ

 

## ğŸ˜Š æ•°æ®ç±»å‹

### ä»‹ç»

ä¸šåŠ¡æ•°æ®çš„ç‰¹æ®Šæ€§

**1ã€ä½œä¸ºç¼“å­˜ä½¿ç”¨**

- åŸå§‹ä¸šåŠ¡åŠŸèƒ½è®¾è®¡ï¼šç§’æ€ã€åŒ11ã€12306
- è¿è¥å¹³å°ç›‘æ§åˆ°çš„çªå‘é«˜é¢‘è®¿é—®æ•°æ®ï¼šçªå‘æ—¶æ”¿è¦é—»
- é«˜é¢‘ã€å¤æ‚çš„ç»Ÿè®¡æ•°æ®ï¼šåœ¨çº¿äººæ•°ã€æŠ•ç¥¨æ’è¡Œæ¦œ

**2ã€é™„åŠ åŠŸèƒ½**

- ç³»ç»ŸåŠŸèƒ½ä¼˜åŒ–æˆ–å‡çº§ï¼šå•æœåŠ¡å™¨å‡çº§é›†ç¾¤ã€Sessionç®¡ç†

**3ã€redisæ•°æ®å­˜å‚¨æ ¼å¼**

redisæ˜¯ä¸€ä¸ªMapï¼Œå…¶ä¸­æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯é‡‡ç”¨key-valueçš„å½¢å¼å­˜å‚¨

- **æ•°æ®ç±»å‹æŒ‡çš„æ˜¯å­˜å‚¨çš„æ•°æ®ç±»å‹ï¼Œä¹Ÿå°±æ˜¯valueéƒ¨åˆ†çš„ç±»å‹ï¼Œkeyæ°¸è¿œæ˜¯å­—ç¬¦ä¸²**

### å¯¹keyçš„æ“ä½œ

```mysql
key * ï¼šæŸ¥çœ‹å½“å‰åº“æ‰€æœ‰çš„key
exists key ï¼šåˆ¤æ–­æŸä¸ªkeyæ˜¯å¦å­˜åœ¨
type key ï¼šæŸ¥çœ‹keyçš„ç±»å‹ 

del key ï¼šåˆ é™¤keyçš„æ•°æ®
unlink key ï¼šæ ¹æ®valueé€‰æ‹©éé˜»å¡åˆ é™¤ï¼Œä»…å°†keysä»å…ƒæ•°æ®ä¸­åˆ é™¤ï¼ŒçœŸæ­£çš„åˆ é™¤åœ¨åç»­å¼‚æ­¥å®Œæˆ

expire key 10 ï¼šä¸ºç»™å®škeyè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼Œä¸è®¾ç½®æ—¶é—´è¡¨ç¤ºæ°¸è¿œä¸è¿‡æœŸ
ttl keyï¼šæŸ¥çœ‹å‰©ä½™æ—¶é—´,-2è¡¨ç¤ºè¿‡æœŸï¼Œ-1è¡¨ç¤ºæ°¸ä¸è¿‡æœŸ

dbsizeï¼šæŸ¥çœ‹å½“å‰æ•°æ®åº“keyçš„æ•°é‡
```

### string

**1ã€å­˜å‚¨çš„æ•°æ®ï¼šå•ä¸ªæ•°æ®ï¼Œæœ€ç®€å•çš„æ•°æ®å­˜å‚¨ç±»å‹ï¼Œæœ€å¸¸ç”¨**

**2ã€å­˜å‚¨æ•°æ®çš„æ ¼å¼ï¼šä¸€ä¸ªå­˜å‚¨ç©ºé—´ä¿å­˜ä¸€ä¸ªæ•°æ®**

3ã€å­˜å‚¨å†…å®¹ï¼šé€šå¸¸ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œå¦‚æœä»¥æ•´æ•°å½¢å¼å±•ç¤ºï¼Œä¹Ÿå¯ä»¥ä½œä¸ºæ•°å­—æ“ä½œï¼Œvalueæœ€å¤§512M

4ã€åŸºæœ¬æ“ä½œ

- æ·»åŠ /ä¿®æ”¹æ•°æ®ï¼š`set key value`
- è·å–æ•°æ®ï¼š`get key`
- åˆ é™¤æ•°æ®ï¼š`del key`

```sql
127.0.0.1:6379> del name                                                                  
(integer) 1 # æ“ä½œæˆåŠŸ
127.0.0.1:6379> del name                                                                  
(integer) 0 # æ“ä½œå¤±è´¥
```

- æ·»åŠ /ä¿®æ”¹å¤šä¸ªæ•°æ®ï¼š`mset key1 value1 key2 value2`
- è·å–å¤šä¸ªæ•°æ®ï¼š`mget key1 key2`
- è·å–æ•°æ®å­—ç¬¦ä¸²ä¸ªæ•°ï¼ˆå­—ç¬¦ä¸²é•¿åº¦ï¼‰ï¼š`strlen key`
- è¿½åŠ ä¿¡æ¯åˆ°åŸå§‹ä¿¡æ¯åéƒ¨ï¼ˆå¦‚æœåŸå§‹ä¿¡æ¯å­˜åœ¨å°±è¿½åŠ ï¼Œå¦åˆ™æ–°å»ºï¼‰ï¼š`append key value`

> å•æ•°æ®æ“ä½œå’Œå¤šæ•°æ®æ“ä½œï¼Ÿ

æ¯”å¦‚ï¼šæ“ä½œä¸‰ä¸ªæ•°æ®

- å•æ•°æ®æ“ä½œï¼š3æ¬¡å‘é€ã€3æ¬¡å›å¤ã€è¿è¡Œä¸‰æ¬¡
- å¤šæ•°æ®æ“ä½œï¼š1æ¬¡å‘é€ï¼Œ1æ¬¡å›å¤ï¼Œè¿è¡Œä¸‰æ¬¡

**ç»“è®ºï¼š**æ²¡æœ‰å›ºå®šç»“è®ºï¼Œå¯¹äºå¤šæ•°æ®æ“ä½œï¼Œå¯èƒ½éœ€è¦åˆ‡å‰²

**5ã€Stringç±»å‹æ•°æ®çš„æ‰©å±•æ“ä½œ**

> ä¸šåŠ¡åœºæ™¯ï¼šåˆ†å¸ƒå¼ID
>
> å¯¹äºå¤§å‹ä¼ä¸šçº§åº”ç”¨ï¼Œåˆ†è¡¨æ“ä½œæ˜¯åŸºæœ¬æ“ä½œï¼Œä½¿ç”¨å¤šå¼ è¡¨å­˜å‚¨åŒç±»å‹æ•°æ®ï¼Œä½†æ˜¯å¯¹åº”çš„ä¸»é”®idå¿…é¡»ä¿è¯ç»Ÿä¸€æ€§ï¼Œä¸èƒ½é‡å¤ï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**

- è®¾ç½®æ•°å€¼æ•°æ®å¢åŠ æŒ‡å®šèŒƒå›´çš„å€¼

  ```sql
  # åŠ 1
  incr key
  # åŠ æŒ‡å®šæ•°
  incrby key increment
  incrbyfloat key increment
  ```

- è®¾ç½®æ•°å€¼å‡å°‘æŒ‡å®šèŒƒå›´çš„å€¼

  ```sql
  decr key
  decrby key increment
  ```

Stingä½œä¸ºæ•°å€¼æ“ä½œ

- stringåœ¨rediså†…éƒ¨å­˜å‚¨é»˜è®¤å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå½“é‡åˆ°å¢å‡ç±»æ“ä½œincrã€decæ—¶ä¼šè½¬ä¸ºæ•°å€¼å‹è¿›è¡Œè®¡ç®—
- **redisæ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œé‡‡ç”¨å•çº¿ç¨‹å¤„ç†æ‰€æœ‰çš„ä¸šåŠ¡ï¼Œå‘½ä»¤ä¸€ä¸ªä¸ªæ‰§è¡Œ**
- æ³¨æ„ï¼šå¦‚æœåŸå§‹æ•°æ®ä¸èƒ½è½¬ä¸ºæ•°å€¼æˆ–è€…è¶…è¶Šäº†æ•°å€¼ä¸Šé™ï¼Œå°±ä¼šæŠ¥é”™

**redisç”¨äºæ§åˆ¶æ•°æ®åº“ä¸»é”®idï¼Œä¸ºæ•°æ®åº“è¡¨ä¸»é”®æä¾›ç”Ÿæˆç­–ç•¥ï¼Œä¿éšœæ•°æ®åº“è¡¨çš„ä¸»é”®å”¯ä¸€æ€§**

> ä¸šåŠ¡åœºæ™¯ï¼šæ§åˆ¶æ—¶æ•ˆæ€§

**è§£å†³æ–¹æ¡ˆ**

- è®¾ç½®æ•°æ®å…·æœ‰æŒ‡å®šçš„ç”Ÿå‘½å‘¨æœŸ

  ```sql
  setex key seconds value
  psetex key milliseconds value
  ```

redisæ§åˆ¶æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸï¼Œé€šè¿‡æ•°æ®æ˜¯å¦å¤±æ•ˆæ§åˆ¶ä¸šåŠ¡è¡Œä¸ºï¼Œé€‚ç”¨äºæ‰€æœ‰å…·æœ‰æ—¶æ•ˆæ€§é™å®šæ§åˆ¶çš„æ“ä½œ

**6ã€æ•°æ®ç»“æ„**

Stringçš„æ•°æ®ç»“æ„ä¸ºç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰ï¼Œæ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œå†…éƒ¨ç»“æ„å®ç°ç±»ä¼¼äºjavaçš„arraylistï¼Œé‡‡ç”¨é¢„åˆ†é…å†—ä½™ç©ºé—´çš„æ–¹å¼æ¥å‡å°‘å†…å­˜çš„é¢‘ç¹åˆ†é…ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/77dffea9b4bd42509d140cead0bc18a8.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

å†…éƒ¨ä¸ºå½“å‰å­—ç¬¦ä¸²å®é™…åˆ†é…çš„ç©ºé—´capacityï¼Œä¸€èˆ¬é«˜äºå®é™…å­—ç¬¦ä¸²é•¿åº¦lenï¼Œå½“å­—ç¬¦ä¸²é•¿åº¦å°äº1Mæ—¶ï¼Œæ‰©å®¹éƒ½æ˜¯2å€ï¼Œå¦‚æœè¶…è¿‡1Mï¼Œæ‰©å®¹ä¸€æ¬¡åªå¤šæ‰©å®¹1Mç©ºé—´ã€‚ï¼ˆæœ€é•¿512Mï¼‰

### Listï¼šå•é”®å¤šå€¼

1ã€ç®€ä»‹

- Redisåˆ—è¡¨æ˜¯ç®€å•çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼ŒæŒ‰ç…§**æ’å…¥é¡ºåºæ’åº**
- å¯ä»¥æ·»åŠ ä¸€ä¸ªå…ƒç´ åˆ°åˆ—è¡¨çš„å¤´éƒ¨æˆ–è€…å°¾éƒ¨
- åº•å±‚å®é™…ä¸Šæ˜¯ä¸ª**åŒå‘åˆ—è¡¨**ï¼Œå¯¹ä¸¤ç«¯æ“ä½œæ€§èƒ½å¾ˆé«˜

**2ã€åŸºæœ¬æ“ä½œ**

- æ·»åŠ æ•°æ®/ä¿®æ”¹æ•°æ®

  ```sql
  lpush key value1 [value2]...
  rpush key value1 [value2]...
  ```

- è·å–æ•°æ®

  ```sql
  lrange key start stop    (lrange list1 0 -1)   
  lindex key index
  llen key
  ```

- è·å–å¹¶ç§»é™¤æ•°æ®

  ```sql
  lpop key
  rpop key
  ```

**3ã€æ‰©å±•æ“ä½œ**

- è§„å®šæ—¶é—´å†…è·å–å¹¶ç§»é™¤æ•°æ®ï¼Œé˜»å¡å¼æ•°æ®è·å–

  ```sql
  blpop key1 [key2] timeout
  brpop key1 [key2] timeout
  ```

> ä¸šåŠ¡åœºæ™¯ï¼šå¾®ä¿¡æœ‹å‹åœˆç‚¹èµï¼Œè¦æ±‚æŒ‰ç…§ç‚¹èµé¡ºåºæ˜¾ç¤ºç‚¹èµå¥½å‹ä¿¡æ¯

<img src="https://img-blog.csdnimg.cn/20210417170350860.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

**ä»ä¸­é—´å–æ¶ˆå…ƒç´ ï¼Œç§»é™¤æŒ‡å®šå…ƒç´ **

```sql
lrem key count value

ä¾‹å­ï¼š
lrem list01 1 d
```

**4ã€æ³¨æ„äº‹é¡¹**

- listä¸­ä¿å­˜çš„æ•°æ®æ˜¯stringç±»å‹
- å…·æœ‰ç´¢å¼•æ¦‚å¿µï¼Œä½†æ˜¯æ“ä½œæ•°æ®é€šå¸¸ä»¥é˜Ÿåˆ—å½¢å¼è¿›è¡Œå…¥é˜Ÿå‡ºé˜Ÿï¼Œæˆ–è€…æ ˆçš„å½¢å¼
- listå¯ä»¥å¯¹æ•°æ®è¿›è¡Œåˆ†é¡µæ“ä½œï¼Œé€šå¸¸ç¬¬ä¸€é¡µä¿¡æ¯æ¥è‡ªlistï¼Œç¬¬2é¡µåŠæ›´å¤šä¿¡æ¯é€šè¿‡æ•°æ®åº“å½¢å¼åŠ è½½

**5ã€æ•°æ®ç»“æ„**

Listçš„æ•°æ®ç»“æ„ä¸º**å¿«é€Ÿé“¾è¡¨**ï¼ˆquickListï¼‰

- åˆ—è¡¨å…ƒç´ è¾ƒå°‘çš„æƒ…å†µä¸‹ä¼šä½¿ç”¨ä¸€å—è¿ç»­çš„å†…å­˜å­˜å‚¨ï¼Œè¿™ä¸ªç»“æ„æ˜¯**zipList**ï¼Œå®ƒå°†æ‰€æœ‰çš„å…ƒç´ ç´§æŒ¨ç€ä¸€èµ·å­˜å‚¨ï¼Œåˆ†é…çš„æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜

- æ•°æ®é‡è¾ƒå¤šçš„æƒ…å†µä¸‹ä¼šä½¿ç”¨**quickList**

  - å› ä¸ºæ™®é€šé“¾è¡¨éœ€è¦çš„é™„åŠ æŒ‡é’ˆç©ºé—´å¤ªå¤§ï¼Œä¼šæ¯”è¾ƒæµªè´¹ç©ºé—´

  - Rediså°†é“¾è¡¨å’ŒzipListç»“åˆèµ·æ¥ç»„æˆquickListï¼Œå°†å¤šä¸ªziplistä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²èµ·æ¥ä½¿ç”¨

  ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/5eff04b5fdee4157af248456e0b2e81d.png)



### Set

> å¯¹å¤–æä¾›åŠŸèƒ½ä¸listç±»ä¼¼çš„ä¸€ä¸ªåˆ—è¡¨çš„åŠŸèƒ½ï¼Œç‰¹æ®Šä¹‹å¤„åœ¨äºsetå¯ä»¥**è‡ªåŠ¨æ’é‡**ï¼Œå½“éœ€è¦ä¸€ä¸ªåˆ—è¡¨æ•°æ®ä½†ä¸å¸Œæœ›å‡ºç°é‡å¤æ—¶ï¼Œsetæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œå¹¶ä¸”setæä¾›äº†åˆ¤æ–­æŸä¸ªæˆå‘˜æ˜¯å¦åœ¨é›†åˆå†…çš„æ¥å£
>
> Redisçš„setæ—¶stringç±»å‹çš„æ— åºé›†åˆï¼Œåº•å±‚æ˜¯valueä¸ºnullçš„**hashè¡¨**ï¼Œå¤æ‚åº¦ä¸ºOï¼ˆ1 ï¼‰

<img src="https://img-blog.csdnimg.cn/20210417171747798.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

**1ã€åŸºæœ¬æ“ä½œ**

- æ·»åŠ æ•°æ®

  ```sql
  sadd key m1 m2...
  ```

- è·å–å…¨éƒ¨æ•°æ®

  ```sql
  smembers key
  ```

- åˆ é™¤æ•°æ®

  ```sql
  srem key m1 m2
  ```

- è·å–é›†åˆæ•°æ®æ€»é‡

  ```sql
  scard key
  ```

- åˆ¤æ–­é›†åˆä¸­æ˜¯å¦åŒ…å«æŒ‡å®šæ•°æ®

  ```sql
  sismember key member
  ```

**2ã€æ‰©å±•æ“ä½œ**

> æ¯ä½ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨ä»Šæ—¥å¤´æ¡ä¼šè®¾ç½®3ä¸ªçˆ±å¥½çš„å†…å®¹ï¼ŒåæœŸä¸ºäº†å¢åŠ ç”¨æˆ·çš„æ´»è·ƒåº¦ï¼Œéœ€è¦è®©ç”¨æˆ·å¯¹å…¶ä»–ä¿¡æ¯ç±»åˆ«é€æ¸äº§ç”Ÿå…´è¶£ï¼Œå¦‚ä½•å®ç°ï¼Ÿ

ä¸šåŠ¡åˆ†æ

- ç³»ç»Ÿåˆ†æå‡ºå„ä¸ªåˆ†ç±»çš„æœ€æ–°æˆ–æœ€çƒ­ç‚¹ä¿¡æ¯æ¡ç›®å¹¶ç»„ç»‡æˆseté›†åˆ
- éšæœºæŒ‘é€‰å…¶ä¸­éƒ¨åˆ†ä¿¡æ¯
- é…åˆç”¨æˆ·å…³æ³¨ä¿¡æ¯åˆ†ç±»ä¸­çš„çƒ­ç‚¹ä¿¡æ¯ç»„ç»‡æˆå±•ç¤ºçš„å…¨ä¿¡æ¯é›†åˆ

è§£å†³æ–¹æ¡ˆ

- éšæœºè·å–é›†åˆä¸­æŒ‡å®šæ•°é‡çš„æ•°æ®

  ```sql
  srandmember key count
  ```

- **éšæœºè·å–**é›†åˆä¸­æŸä¸ªæ•°æ®å¹¶å°†æ•°æ®ç§»å‡ºé›†åˆ

  ```sql
  spop key
  ```

**éšæœºæ¨èç±»ä¿¡æ¯æ£€ç´¢ï¼Œå¦‚çƒ­ç‚¹æ­Œå•æ¨è**

> qqå¥½å‹æ¨èï¼ˆå…±åŒå¥½å‹ï¼‰ã€å¾®åšæ¨è

è§£å†³æ–¹æ¡ˆ

- æ±‚ä¸¤ä¸ªé›†åˆçš„**äº¤ã€å¹¶ã€å·®**

  ```sql
  sinter key1 key2
  sunion key1 key2
  sdiff key1 key2
  ```

- æ±‚ä¸¤ä¸ªé›†åˆçš„äº¤ã€å¹¶ã€å·®å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆ

  ```mysql
  sinterstore targetkey key1 key2
  sunionstore targetkey key1 key2
  sdiffstore targetkey key1 key2
  ```

- å°†æŒ‡å®šæ•°æ®ä»åŸå§‹é›†åˆç§»åŠ¨åˆ°ç›®æ ‡é›†åˆ

  ```sql
  smove source targetkey member
  ```

**redisåº”ç”¨äºåŒç±»ä¿¡æ¯çš„å…³è”æœç´¢ï¼ŒäºŒåº¦å…³è”æœç´¢ã€æ·±åº¦å…³è”æœç´¢**

**æ˜¾ç¤ºå…±åŒå¥½å‹ã€å…±åŒå…³æ³¨**

3ã€æ³¨æ„äº‹é¡¹

- setç±»å‹ä¸å…è®¸æ•°æ®é‡å¤
- setè™½ç„¶å’Œhashå­˜å‚¨ç»“æ„ç›¸åŒï¼Œæ— æ³•å¯ç”¨hashä¸­çš„å­˜å‚¨å€¼çš„ç©ºé—´

4ã€åº”ç”¨åœºæ™¯

> é›†å›¢æœ‰1000åå‘˜å·¥ï¼Œå†…éƒ¨ç³»ç»Ÿæœ‰700å¤šä¸ªè§’è‰²ï¼Œ3000å¤šä¸ªä¸šåŠ¡æ“ä½œï¼Œ23000å¤šç§æ•°æ®æ¯ä½å‘˜å·¥å…·æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²ï¼Œå¦‚ä½•è¿›è¡Œæƒé™æ ¡éªŒï¼Ÿ

è§£å†³æ–¹æ¡ˆï¼š

- æ ¹æ®ç”¨æˆ·idè·å–ç”¨æˆ·æ‰€æœ‰è§’è‰²
- æ ¹æ®ç”¨æˆ·æ‰€æœ‰è§’è‰²è·å–ç”¨æˆ·æ‰€æœ‰æ“ä½œæƒé™æ”¾å…¥seté›†åˆï¼ˆåˆå¹¶å¹¶å­˜å‚¨ï¼‰
- æ ¹æ®ç”¨æˆ·æ‰€æœ‰è§’è‰²è·å–ç”¨æˆ·æ‰€æœ‰æ•°æ®å…¨é€‰æ”¾å…¥seté›†åˆ

> ç»Ÿè®¡ç½‘ç«™çš„PVï¼ˆè®¿é—®é‡ï¼‰ã€UVï¼ˆç‹¬ç«‹è®¿å®¢ï¼‰ã€IPï¼ˆç‹¬ç«‹IPï¼‰
>
> PVï¼šè¢«è®¿é—®çš„æ¬¡æ•°
>
> UVï¼šä¸åŒç”¨æˆ·è®¿é—®æ¬¡æ•°
>
> IPï¼šä¸åŒIPåœ°å€è®¿é—®æ¬¡æ•°

è§£å†³æ–¹æ¡ˆï¼š

- å»ºç«‹stringç±»å‹æ•°æ®ï¼Œåˆ©ç”¨incrç»Ÿè®¡æ—¥è®¿é—®é‡ï¼ˆPVï¼‰
- å»ºç«‹setæ¨¡å‹ï¼Œè®°å½•ä¸åŒcookieæ•°é‡ï¼ˆUVï¼‰
- å»ºç«‹setæ¨¡å‹ï¼Œè®°å½•ä¸åŒipæ•°é‡ï¼ˆIPï¼‰

> é»‘ç™½åå•

è§£å†³æ–¹æ¡ˆï¼š

- å‘¨æœŸæ€§æ›´æ–°ç”¨æˆ·é»‘åå•ï¼ŒåŠ å…¥seté›†åˆ
- ç”¨æˆ·è¡Œä¸ºä¿¡æ¯åˆ°è¾¾åå’Œé»‘åå•è¿›è¡Œæ¯”å¯¹ï¼Œç¡®è®¤è¡Œä¸ºå»å‘
- é»‘åå•è¿‡æ»¤IPåœ°å€ï¼šåº”ç”¨äºå¼€æ”¾æ¸¸å®¢è®¿é—®æƒé™çš„ä¿¡æ¯æº
- é»‘åå•è¿‡æ»¤è®¾å¤‡ä¿¡æ¯ï¼šåº”ç”¨äºé™å®šè®¿é—®è®¾å¤‡çš„ä¿¡æ¯æº
- é»‘åå•è¿‡æ»¤ç”¨æˆ·ï¼šåº”ç”¨äºåŸºäºè®¿é—®æƒé™çš„ä¿¡æ¯æº

**5ã€æ•°æ®ç»“æ„**

setçš„æ•°æ®ç»“æ„æ˜¯dictå­—å…¸ï¼Œå­—å…¸æ˜¯ç”¨å“ˆå¸Œè¡¨å®ç°çš„

Javaä¸­çš„HashSetçš„å†…éƒ¨å®ç°ä½¿ç”¨HashMapï¼ŒRedisçš„setç»“æ„ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå†…éƒ¨ä½¿ç”¨hashç»“æ„ï¼Œæ‰€æœ‰çš„valueæŒ‡å‘åŒä¸€ä¸ªå†…éƒ¨å€¼



### Hash

1ã€ç®€ä»‹

- é”®å€¼å¯¹é›†åˆ
- æ˜¯ä¸€ä¸ªstringç±»å‹çš„fieldå’Œvalueçš„æ˜ å°„è¡¨ï¼Œhashç‰¹åˆ«é€‚åˆå­˜å‚¨å¯¹è±¡

<img src="https://img-blog.csdnimg.cn/20210417161600331.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

2ã€åŸºæœ¬æ“ä½œ

- æ·»åŠ /ä¿®æ”¹æ•°æ®ï¼š`hset key field value`

- è·å–æ•°æ®ï¼š

  ```sql
  hget key field
  hgetall key
  ```

- æ·»åŠ /ä¿®æ”¹å¤šä¸ªæ•°æ®ï¼š`hmset key field1 value1 field2 value2`

- è·å–å¤šä¸ªæ•°æ®ï¼š`hmget key field1 field2`

- è·å–å“ˆå¸Œè¡¨ä¸­å­—æ®µçš„æ•°é‡ï¼š`hlen key`

- è·å–å“ˆå¸Œè¡¨ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šå­—æ®µï¼š`hexists key field`

**3ã€æ‰©å±•æ“ä½œ**

- è·å–å“ˆå¸Œè¡¨æ‰€æœ‰çš„å­—æ®µåæˆ–å­—æ®µå€¼

  ```sql
  hkeys key
  hvals key
  ```

- è®¾ç½®æŒ‡å®šå­—æ®µçš„æ•°å€¼æ•°æ®å¢åŠ æŒ‡å®šèŒƒå›´çš„å€¼

  ```sql
  hincrby key field increment
  hincrbyfloat key field increment
  ```

**4ã€æ³¨æ„äº‹é¡¹**

- hashç±»å‹çš„valueåªèƒ½å­˜å‚¨å­—ç¬¦ä¸²
- æ¯ä¸ªhashå¯ä»¥å­˜å‚¨2^32-1ä¸ª
- hgetallæ“ä½œå¯ä»¥è·å–å…¨éƒ¨å±æ€§ï¼Œå¦‚æœfieldè¿‡å¤šï¼Œéå†æ•ˆç‡ä¼šå¾ˆä½ï¼Œæœ‰å¯èƒ½æˆä¸ºæ•°æ®è®¿é—®ç“¶é¢ˆ

**4ã€åº”ç”¨åœºæ™¯**

> è´­ç‰©è½¦è®¾è®¡å’Œå®ç°

<img src="https://img-blog.csdnimg.cn/20210417162753154.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;" />

**ä¸šåŠ¡åˆ†æ**

- æ·»åŠ ã€æµè§ˆã€æ›´æ”¹æ•°é‡ã€åˆ é™¤ã€æ¸…ç©º

**è§£å†³æ–¹æ¡ˆ**

- ç”¨æˆ·idä¸ºkeyï¼Œæ¯ä½å®¢æˆ·åˆ›å»ºä¸€ä¸ªhashå­˜å‚¨ç»“æ„å­˜å‚¨å¯¹åº”çš„è´­ç‰©è½¦ä¿¡æ¯
- å•†å“ç¼–å·ä¸ºfieldï¼Œè´­ä¹°æ•°é‡ä¸ºvalue
- æ·»åŠ å•†å“ï¼šè¿½åŠ å…¨æ–°çš„fieldå’Œæ•°é‡value
- æµè§ˆï¼šéå†hash
- æ›´æ”¹æ•°é‡ï¼šè‡ªå¢/è‡ªå‡ï¼Œè®¾ç½®valueå€¼
- åˆ é™¤å•†å“ï¼šåˆ é™¤field
- æ¸…ç©ºï¼šåˆ é™¤key

**é—®é¢˜ï¼šå½“å‰åªæ˜¯å°†æ•°æ®å­˜å‚¨åˆ°äº†redisä¸­ï¼Œå¹¶æ²¡æœ‰èµ·åˆ°åŠ é€Ÿçš„ä½œç”¨ï¼Œå•†å“ä¿¡æ¯è¿˜éœ€è¦äºŒæ¬¡æŸ¥è¯¢æ•°æ®åº“**

- æ¯æ¡å•†å“è®°å½•ä¿å­˜ä¸ºä¸¤æ¡field
- field1ç”¨äºä¿å­˜è´­ä¹°æ•°é‡
  - å‘½åæ ¼å¼ï¼š`å•†å“idï¼šnums`
  - æ•°æ®ï¼šæ•°å€¼

- field2ç”¨äºä¿å­˜è´­ç‰©è½¦æ˜¾ç¤ºçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡å­—æè¿°ã€å›¾ç‰‡åœ°å€ç­‰
  - å‘½åæ ¼å¼ï¼š`å•†å“idï¼šinfo`
  - æ•°æ®ï¼šjson

```sql
127.0.0.1:6379> hmset 004 g01:nums 100 g01:info {...}                                     
OK                                                                                                                                                            
127.0.0.1:6379> hgetall 004                                                               
1) "g01:nums"                                                                             
2) "100"                                                                                  
3) "g01:info"                                                                             
4) "{...}"                                                                                
127.0.0.1:6379> 
```

**ä¼˜åŒ–ï¼šå•†å“ç›¸åŒï¼Œä¼šå‡ºç°ä¿¡æ¯é‡å¤ï¼Œå¯ä»¥å°†field2ç‹¬ç«‹æˆhash**

```sql
# å¦‚æœkeyä¸­å¯¹åº”çš„fieldæœ‰vlaueï¼Œä»€ä¹ˆéƒ½ä¸åšï¼Œæ²¡æœ‰å€¼å°±åŠ è¿›å»
hsetnx key field value
```

> æŠ¢è´­å•†å“

<img src="https://img-blog.csdnimg.cn/2021041716452792.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

è§£å†³æ–¹æ¡ˆï¼š

- ä»¥å•†å®¶idä½œä¸ºkey
- å‚ä¸æŠ¢è´­çš„å•†å“idä½œä¸ºfield
- æ•°é‡ä¸ºvalue
- ä½¿ç”¨é™å€¼çš„æ–¹å¼æ§åˆ¶

**5ã€æ•°æ®ç»“æ„**

Hashå¯¹åº”çš„æ•°æ®ç»“æ„æœ‰ä¸¤ç§ï¼šziplistã€hashtable

- field-valueé•¿åº¦è¾ƒçŸ­ä¸”ä¸ªæ•°è¾ƒå°‘ï¼Œä½¿ç”¨ziplist
- field-valueé•¿åº¦è¾ƒé•¿ä¸”ä¸ªæ•°è¾ƒå¤šï¼Œä½¿ç”¨hashtable



### Zsetæœ‰åºé›†åˆ

> æ–°çš„å­˜å‚¨éœ€æ±‚ï¼šæ•°æ®æ’åºæœ‰åˆ©äºæ•°æ®æœ‰æ•ˆå±•ç¤ºï¼Œéœ€è¦æä¾›ä¸€ç§å¯ä»¥æ ¹æ®è‡ªèº«ç‰¹å¾è¿›è¡Œæ’åºçš„æ–¹å¼
>
> éœ€è¦çš„å­˜å‚¨ç»“æ„ï¼šæ–°çš„å­˜å‚¨æ¨¡å‹ï¼Œå¯ä»¥ä¿å­˜å¯æ’åºçš„æ•°æ®
>
> zsetç±»å‹ï¼šåœ¨setçš„å­˜å‚¨ç»“æ„åŸºç¡€ä¸Šæ·»åŠ å¯æ’åºå­—æ®µ score



<img src="https://img-blog.csdnimg.cn/20210417175132505.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

**1ã€åŸºæœ¬æ“ä½œ**

- æ·»åŠ æ•°æ®

  ```sql
  zadd key score1 m1 score2 m2
  ```

- è·å–å…¨éƒ¨æ•°æ®ï¼Œå·²ç»æ’åº

  ```sql
  # ä»å°åˆ°å¤§
  zrange key start stop ã€withscoresã€‘
  # ä»å¤§åˆ°å°
  zrevrange key start stop ã€withscoresã€‘
  ```

- åˆ é™¤æ•°æ®

  ```sql
  zrem key m1 m2 m3...
  ```

- æŒ‰æ¡ä»¶è·å–æ•°æ®

  ```sql
  zrangebyscore key min max [withscores][limit]
  zrevrangebyscore key max min [withscores]
  ```

- æ¡ä»¶åˆ é™¤æ•°æ®

  ```sql
  zremrangebyrank key start stop
  zremrangebyscore key min max
  ```

- è·å–é›†åˆæ•°æ®æ€»é‡

  ```sql
  zcard key
  zcount key min max
  ```

- é›†åˆäº¤ã€å¹¶æ“ä½œ

  ```sql
  zinterstore target numkeys key1 key2
  zunionstore target numkeys key1 key2
  ```

**2ã€æ‰©å±•æ“ä½œ**

> ç”µå½±TOP10
>
> - å¯¹èµ„æºå»ºç«‹æ’åºä¾æ®

è§£å†³æ–¹æ¡ˆ

- è·å–æ•°æ®å¯¹åº”çš„ç´¢å¼•ï¼ˆæ’åï¼‰

  ```sql
  zrank key member
  zrevrank key member
  ```

- scoreå€¼è·å–ä¸ä¿®æ”¹

  ```sql
  zscore key member
  zincrby key increment member
  ```

3ã€æ³¨æ„äº‹é¡¹

- scoreæœ‰èŒƒå›´ï¼Œ64ä½
- scoreä¿å­˜çš„æ•°æ®å¯ä»¥æ˜¯ä¸€ä¸ªåŒç²¾åº¦doubleå€¼ï¼ŒåŸºäºåŒç²¾åº¦æµ®ç‚¹æ•°çš„ç‰¹å¾å¯èƒ½ä¼šä¸¢å¤±ç²¾åº¦ï¼Œä½¿ç”¨æ—¶è¦æ…é‡
- **zsetåº•å±‚å­˜å‚¨è¿˜æ˜¯åŸºäºsetç»“æ„ï¼Œå› æ­¤æ•°æ®ä¸èƒ½é‡å¤ï¼Œå¦‚æœé‡å¤æ·»åŠ ç›¸åŒæ•°æ®ï¼Œscoreä¼šè¢«è¦†ç›–ï¼Œä¿ç•™æœ€åä¸€æ¬¡ä¿®æ”¹çš„ç»“æœ**

**4ã€åº”ç”¨åœºæ™¯**

> åŸºäºæ—¶æ•ˆæ€§ä»»åŠ¡ç®¡ç†
>
> è¯•ç”¨VIPï¼ŒVIPåˆ°æœŸä¹‹åï¼Œå¦‚æœæœ‰æ•ˆç®¡ç†æ­¤ç±»ä¿¡æ¯ï¼Œå³ä¾¿å¯¹äºæ­£å¼VIPç”¨æˆ·ä¹Ÿå­˜åœ¨å¯¹åº”çš„ç®¡ç†æ–¹å¼

è§£å†³æ–¹æ¡ˆ

- å°†å¤„ç†æ—¶é—´è®°å½•ä¸ºscoreå€¼
- è®°å½•ä¸‹ä¸€ä¸ªè¦å¤„ç†çš„æ—¶é—´ï¼Œå½“åˆ°æœŸåå¤„ç†å¯¹åº”ä»»åŠ¡ï¼Œç§»é™¤redisä¸­çš„è®°å½•ï¼Œè®°å½•ä¸‹ä¸€ä¸ªè¦å¤„ç†çš„æ—¶é—´
- æ–°ä»»åŠ¡åŠ å…¥æ—¶ï¼Œåˆ¤å®šå¹¶æ›´æ–°å½“å‰ä¸‹ä¸€ä¸ªè¦å¤„ç†çš„ä»»åŠ¡æ—¶é—´
- ä¸ºäº†æå‡æ€§èƒ½ï¼Œé€šå¸¸å°†ä»»åŠ¡æ ¹æ®ç‰¹å¾å­˜å‚¨æˆè‹¥å¹²ä¸ªzsetï¼Œä¾‹å¦‚1å°æ—¶å†…ã€1å¤©å†…ç­‰ï¼Œæ“ä½œæ—¶é€çº§æå‡ï¼Œå°†å³å°†æ“ä½œçš„è‹¥å¹²ä¸ªä»»åŠ¡çº³å…¥1å°æ—¶å†…å¤„ç†çš„é˜Ÿåˆ—ä¸­
- è·å–å½“å‰ç³»ç»Ÿæ—¶é—´ï¼š`time`

> æƒé‡ä»»åŠ¡é˜Ÿåˆ—/æ¶ˆæ¯é˜Ÿåˆ—

è§£å†³æ–¹æ¡ˆ

- å¯¹äºå¸¦æƒé‡çš„ä»»åŠ¡ï¼Œä¼˜å…ˆå¤„ç†æƒé‡é«˜çš„ä»»åŠ¡ï¼Œé‡‡ç”¨scoreè®°å½•æƒé‡

**å¤šæ¡ä»¶ä»»åŠ¡æƒé‡**

- å¦‚æœæƒé™è¿‡å¤šï¼Œéœ€è¦å¯¹æ’åºscoreå€¼è¿›è¡Œå¤„ç†

**5ã€æ•°æ®ç»“æ„**

zsetæ˜¯Redisæä¾›çš„ä¸€ä¸ªéå¸¸ç‰¹åˆ«çš„æ•°æ®ç»“æ„ï¼Œä¸€æ–¹é¢ç­‰ä»·äºjavaçš„Map<String,Double>ï¼Œå¯ä»¥ç»™æ¯ä¸ªå…ƒç´ valueèµ‹äºˆä¸€ä¸ªæƒé‡scoreï¼Œå¦ä¸€æ–¹é¢åˆç±»ä¼¼äºTreeSetï¼Œå†…éƒ¨çš„å…ƒç´ ä¼šæŒ‰ç…§scoreè¿›è¡Œæ’åºï¼Œå¾—åˆ°æ¯ä¸ªå…ƒç´ çš„åæ¬¡ï¼Œè¿˜å¯ä»¥æ ¹æ®scoreçš„èŒƒå›´è·å–å…ƒç´ çš„åˆ—è¡¨

åº•å±‚ä½¿ç”¨äº†ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼š

- **hash**ï¼Œhashçš„ä½œç”¨æ˜¯å…³è”valueå’Œscoreï¼Œä¿éšœå…ƒç´ valueçš„å”¯ä¸€æ€§ï¼Œå¯ä»¥é€šè¿‡å…ƒç´ valueæ‰¾åˆ°å¯¹åº”çš„score
- **è·³è¡¨**ï¼Œç›®çš„æ˜¯ç»™valueæ’åºï¼Œæ ¹æ®scoreçš„èŒƒå›´è·å–å…ƒç´ åˆ—è¡¨





### Redisé…ç½®æ–‡ä»¶

```conf
################################## NETWORK #####################################

# è¡¨ç¤ºåªèƒ½æœ¬åœ°è®¿é—®
bind 127.0.0.1 ::1

# è¡¨ç¤ºå¼€å¯ä¿æŠ¤æ¨¡å¼
protected-mode yes

port 6379

# è®¾ç½®tcpçš„backlogï¼Œbacklogæ˜¯ä¸€ä¸ªè¿æ¥é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æ€»å’Œ=æœªå®Œæˆä¸‰æ¬¡æ¡æ‰‹é˜Ÿåˆ—+å·²ç»å®Œæˆä¸‰æ¬¡æ¡æ‰‹é˜Ÿåˆ—
tcp-backlog 511

# è¶…æ—¶æ—¶é—´ 0è¡¨ç¤ºæ°¸ä¸è¶…æ—¶
timeout 0

# è¡¨ç¤ºæ£€æŸ¥å¿ƒè·³çš„æ—¶é—´
tcp-keepalive 300

################################# TLS/SSL #####################################


################################# GENERAL #####################################
# redisåå°å¯åŠ¨
daemonize no

# ä¿å­˜è¿›ç¨‹å·
pidfile /var/run/redis_6379.pid

# æ—¥å¿—çº§åˆ«ï¼š
# debug (a lot of information, useful for development/testing)
# verbose (many rarely useful info, but not a mess like the debug level)
# notice (moderately verbose, what you want in production probably)
# warning (only very important / critical messages are logged)
loglevel notice

# æ—¥å¿—è¾“å‡ºæ–‡ä»¶è·¯å¾„
logfile ""

# æ•°æ®åº“ä¸ªæ•°
databases 16

always-show-logo no

set-proc-title yes

################################ SNAPSHOTTING  ################################
stop-writes-on-bgsave-error yes

rdbcompression yes

rdbchecksum yes

dbfilename dump.rdb

dir /usr/local/var/db/redis/

################################# REPLICATION #################################

replica-serve-stale-data yes

replica-read-only yes

repl-diskless-sync no

repl-diskless-sync-delay 5

############################### KEYS TRACKING #################################


################################## SECURITY ###################################


################################### CLIENTS ####################################


############################## MEMORY MANAGEMENT ################################


############################# LAZY FREEING ####################################

lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no


lazyfree-lazy-user-del no

lazyfree-lazy-user-flush no

################################ THREADED I/O #################################

############################ KERNEL OOM CONTROL ##############################
oom-score-adj no
oom-score-adj-values 0 200 800


#################### KERNEL transparent hugepage CONTROL ######################

disable-thp yes

############################## APPEND ONLY MODE ###############################
appendonly no

no-appendfsync-on-rewrite no

auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

aof-load-truncated yes

aof-use-rdb-preamble yes

################################ LUA SCRIPTING  ###############################

lua-time-limit 5000

################################ REDIS CLUSTER  ###############################


########################## CLUSTER DOCKER/NAT support  ########################


################################## SLOW LOG ###################################

slowlog-max-len 128

################################ LATENCY MONITOR ##############################


############################### GOPHER SERVER #################################


############################### ADVANCED CONFIG ###############################

```

### å‘å¸ƒå’Œè®¢é˜…

1ã€Redså‘å¸ƒè®¢é˜…æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼

2ã€Rediså®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“

3ã€å‘½ä»¤è¡Œå®ç°

- æ‰“å¼€ä¸€ä¸ªå®¢æˆ·ç«¯è®¢é˜…channel1

  ```sql
  subscribe channel1
  ```

- æ‰“å¼€å¦å¤–ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œç»™channel1å‘å¸ƒæ¶ˆæ¯

  ```sql
  publish channel1 hello
  ```

  

### Bitmaps

1ã€ç®€ä»‹

- æœ¬èº«ä¸æ˜¯ä¸€ç§æ•°æ®ç±»å‹ï¼Œå®é™…ä¸Šæ˜¯å­—ç¬¦ä¸²ï¼Œä½†æ˜¯å¯ä»¥å¯¹å­—ç¬¦ä¸²çš„ä½è¿›è¡Œæ“ä½œ
- å•ç‹¬æä¾›ä¸€å¥—å‘½ä»¤ï¼Œåœ¨redisä¸­ä½¿ç”¨bitmapså’Œ ä½¿ç”¨å­—ç¬¦ä¸²çš„æ–¹æ³•ä¸åŒã€‚å¯ä»¥æŠŠbitmapsæƒ³è±¡æˆä¸€ä¸ªä»¥ä½ä¸ºå•ä½çš„æ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå•å…ƒå­˜å‚¨0å’Œ1

  

### HyperLogLog

### Geospatital



### æ¡ˆä¾‹

> å¾®ä¿¡æ¥æ”¶æ¶ˆæ¯é»˜è®¤å°†æœ€è¿‘æ¥æ”¶çš„æ¶ˆæ¯ç½®é¡¶ï¼Œå¤šä¸ªå¥½å‹åŠè®¢é˜…å·åŒæ—¶å‘æ¶ˆæ¯ï¼Œè¯¥æ’åºä¼šä¸åœè¿›è¡Œäº¤æ›¿ï¼ŒåŒæ—¶è¿˜å¯ä»¥å°†é‡è¦çš„ä¼šè¯è®¾ç½®ä¸ºç½®é¡¶ï¼Œä¸€æ—¦ç”¨æˆ·ç¦»çº¿åï¼Œå†æ¬¡æ‰“å¼€å¾®ä¿¡æ—¶æ¶ˆæ¯æ€ä¹ˆæŒ‰é¡ºåºå±•ç¤ºï¼Ÿ

ä¾èµ–listçš„æ•°æ®å…·æœ‰é¡ºåºçš„ç‰¹å¾

å¯¹ç½®é¡¶å¥½å‹å’Œæ™®é€šå¥½å‹åˆ†åˆ«åˆ›å»ºç‹¬ç«‹çš„list

å½“æŸä¸ªlistæ¥å—åˆ°ç”¨æˆ·æ¶ˆæ¯åï¼Œå°†æ¶ˆæ¯å‘é€æ–¹çš„idä»listçš„ä¸€ä¾§åŠ å…¥list

å¤šä¸ªç›¸åŒidåŠ å…¥éœ€è¦å…ˆåˆ é™¤

å…ˆæ¨é€ç½®é¡¶ä¼šè¯list



## ğŸ˜Š é€šç”¨å‘½ä»¤

### keyé€šç”¨å‘½ä»¤

#### keyç‰¹å¾

1ã€keyæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé€šè¿‡keyè·å–redisä¿å­˜çš„æ•°æ®

> keyåº”è¯¥è®¾è®¡å“ªäº›æ“ä½œï¼Ÿ

å¯¹äºkeyè‡ªèº«çŠ¶æ€ç›¸å…³æ“ä½œ

å¯¹äºkeyæœ‰æ•ˆæ€§æ§åˆ¶ç›¸å…³æ“ä½œ

å¯¹äºkeyå¿«é€ŸæŸ¥è¯¢

#### keyåŸºæœ¬æ“ä½œ

1ã€åˆ é™¤æŒ‡å®škey

```sql
del key
```

2ã€è·å–keyæ˜¯å¦å­˜åœ¨

```sql
exists key
```

3ã€è·å–keyç±»å‹

```sql
type key
```

#### keyæ‰©å±•æ“ä½œï¼ˆæ—¶æ•ˆæ€§ï¼‰

1ã€ä¸ºæŒ‡å®škeyè®¾ç½®æœ‰æ•ˆæœŸ

```sql
expire key seconds
pexpire key milliseconds
expireat key timestamp
pexpireat key milliseconds-timestamp
```

2ã€è·å–keyæœ‰æ•ˆæœŸ

- -2ï¼šä¸å­˜åœ¨
- -1ï¼šå­˜åœ¨
- å½“å‰æœ‰æ•ˆæ—¶é•¿

```sql
ttl key
pttl key
```

3ã€åˆ‡æ¢keyè½¬æ¢åˆ°æ°¸ä¹…æ€§

```sql
persist key
```

#### keyæ‰©å±•æ“ä½œï¼ˆæŸ¥è¯¢æ¨¡å¼ï¼‰

1ã€æŸ¥è¯¢key

- `Keys *` æŸ¥è¯¢ç´¢å¼•
- `Keys it*` æŸ¥è¯¢æ‰€æœ‰ä»¥itå¼€å¤´çš„
- `keys ??h` æŸ¥è¯¢å‰é¢ä¸¤ä¸ªå­—ç¬¦ä»»æ„ï¼Œåé¢ä»¥hç»“å°¾
- `keys user:?` æŸ¥è¯¢æ‰€æœ‰ä»¥userï¼šå¼€å¤´ï¼Œæœ€åä¸€ä¸ªå­—ç¬¦ä»»æ„

```sql
keys pattern
```

#### keyå…¶ä»–æ“ä½œ

1ã€ä¸ºkeyæ”¹åå­—

```sql
# åŒåå°±è¦†ç›–
rename key newkey
# å¦‚æœä¸å­˜åœ¨æ”¹å
renamenx key newkey
```

2ã€å¯¹æ‰€æœ‰keyæ’åº

```sql
sort
```

3ã€å…¶ä»–key é€šç”¨æ“ä½œ

```sql
help @generic
```

### æ•°æ®åº“é€šç”¨å‘½ä»¤

> keyé‡å¤é—®é¢˜

1ã€åˆ‡æ¢æ•°æ®åº“

```sql
select index
```

2ã€å…¶ä»–æ“ä½œ

```sql
quit
ping 
echo message
```

3ã€æ•°æ®ç§»åŠ¨

```sql
move key db_index
```

## ğŸ˜Š Jedis

```java
public void testJedis(){
  //1ã€è¿æ¥redis
  Jedis jedis = new Jedis("192.168.164.134",6379);
  //2ã€æ“ä½œredis
  jedis.select(2);
  jedis.set("name","zhang");
  System.out.println(jedis.get("name"));
  //3ã€å…³é—­è¿æ¥
  jedis.close();
}
```



## ğŸ˜Š äº‹åŠ¡å’Œé”

 Redisäº‹åŠ¡æ˜¯ä¸€ä¸ª**å•ç‹¬çš„éš”ç¦»æ“ä½œ**ï¼Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåºåˆ—åŒ–ã€æŒ‰é¡ºåºæ‰§è¡Œã€‚äº‹åŠ¡åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤è¯·æ±‚æ‰“æ–­

Redisäº‹åŠ¡çš„ä¸»è¦ä½œç”¨æ˜¯**ä¸²è”å¤šä¸ªå‘½ä»¤**é˜²æ­¢åˆ«çš„å‘½ä»¤æ’é˜Ÿ

### Multiã€Execã€discard

ä»è¾“å…¥multiå‘½ä»¤å¼€å§‹ï¼Œè¾“å…¥çš„å‘½ä»¤éƒ½ä¼šä¾æ¬¡è¿›å…¥å‘½ä»¤é˜Ÿåˆ—ä¸­ï¼Œä½†ä¸ä¼šæ‰§è¡Œï¼Œç›´åˆ°è¾“å…¥execå¥‡å¶ï¼Œrediså°†ä¹‹å‰çš„å‘½ä»¤ä¾æ¬¡æ‰§è¡Œã€‚

ç»„é˜Ÿè¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨discardæ”¾å¼ƒç»„é˜Ÿ

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/0343f819374b40799612483619dcf49a.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

1. **å¦‚æœç»„é˜Ÿä¸­å‘½ä»¤å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å‘½ä»¤éƒ½ä¸ä¼šæ‰§è¡Œ**ï¼›
2. **å¦‚æœæ‰§è¡Œå‡ºç°è¿è¡Œé”™è¯¯ï¼Œé‚£ä¹ˆæ­£ç¡®çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œåªæœ‰é”™è¯¯çš„å‘½ä»¤ä¸æ‰§è¡Œ**ã€‚

### äº‹åŠ¡å†²çª

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/4879b58d97404d9781cfad06ca5d850f.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

#### æ‚²è§‚é”

æ¯æ¬¡æ‹¿æ•°æ®çš„æ—¶å€™è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™ä¼šåŠ ä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³å»æ‹¿æ•°æ®å°±ä¼šé˜»å¡ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/16d8ef1f15d94f808b824de927a27dad.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

#### ä¹è§‚é”

ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶

é€‚ç”¨äºå¤šè¯»çš„åº”ç”¨ç±»å‹ï¼Œè¿™æ ·å¯ä»¥æé«˜ååé‡ï¼Œrediså°±æ˜¯ä½¿ç”¨è¿™ç§check-and-setæœºåˆ¶å®ç°äº‹åŠ¡çš„

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/8c46bbf3590449c2aa1497b01a3a1fac.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

#### watch key

åœ¨æ‰§è¡Œmultiä¹‹å‰ï¼Œå…ˆæ‰§è¡Œwatch key1 [key2]ï¼Œå¯ä»¥ç›‘è§†ä¸€ä¸ªæˆ–å¤šä¸ªkeyã€‚

**å¦‚æœåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰è¿™äº›keyè¢«å…¶ä»–å‘½ä»¤æ”¹åŠ¨ï¼Œé‚£ä¹ˆäº‹åŠ¡è¢«æ‰“æ–­ï¼Œç›‘æ§ä¸€ç›´æŒç»­åˆ°EXECå‘½ä»¤**

#### äº‹åŠ¡ä¸‰ç‰¹æ€§

1ã€å•ç‹¬çš„éš”ç¦»æ“ä½œ

- äº‹åŠ¡çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåºåˆ—åŒ–ã€æŒ‰é¡ºåºçš„æ‰§è¡Œã€‚äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤è¯·æ±‚æ‰“æ–­

2ã€æ²¡æœ‰éš”ç¦»çº§åˆ«çš„æ¦‚å¿µ

- é˜Ÿåˆ—çš„å‘½ä»¤åœ¨æäº¤ä¹‹å‰éƒ½ä¸ä¼šæ‰§è¡Œ

3ã€ä¸ä¿è¯åŸå­æ€§

- äº‹åŠ¡ä¸­å¦‚æœæœ‰ä¸€æ¡å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œåé¢çš„å‘½ä»¤ä»ç„¶ä¼šæ‰§è¡Œï¼Œä¸å›æ»š

### ç§’æ€æ¡ˆä¾‹

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/e04b93e8a4b84ae0b156516c698b6357.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

>  seté›†åˆåˆ¤æ–­ç”¨æˆ·æ˜¯å¦é‡å¤ç§’æ€æ“ä½œï¼š`sismember`
>
> åº“å­˜-1ï¼š`decr`

é—®é¢˜ï¼š

- è¿æ¥è¶…æ—¶é—®é¢˜ï¼šä½¿ç”¨è¿æ¥æ± è§£å†³
- **è¶…å–é—®é¢˜**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/3f08040453ee433fa6fd3ddcd19c0cc6.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

è§£å†³æ–¹æ¡ˆï¼š

- **ä¹è§‚é”**

  ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/60d1b46a79e7450f855706ad747adb13.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

```java
//watch
jedis.watch(kcKey);
//è·å–åº“å­˜ï¼Œå¦‚æœåº“å­˜ä¸ºnullï¼Œç§’æ€å¼€æ²¡æœ‰å¼€å§‹

//å¦‚æœå•†å“æ•°é‡å°äº1ï¼Œç§’æ€ç»“æŸ

//å¼€å§‹ç§’æ€
//ä½¿ç”¨äº‹åŠ¡
Transaction multi = jedis.multi();
//ç»„é˜Ÿæ“ä½œ
multi.decr(kcKey);
multi.sadd(userKey,uid);
//æ‰§è¡Œ
List<Object> results = multi.exec();
if(results==null || results.size()==0){
  jedis.close(); 
}
```

**åº“å­˜é—ç•™é—®é¢˜**

- ä¹è§‚é”é€ æˆåº“å­˜é—ç•™é—®é¢˜
- è§£å†³ï¼š
  - LUAè„šæœ¬
    - å°†å¤æ‚çš„æˆ–è€…å¤šæ­¥çš„redisæ“ä½œï¼Œå†™ä¸ºä¸€ä¸ªè„šæœ¬ï¼Œä¸€æ¬¡æäº¤ç»™redisæ‰§è¡Œï¼Œå‡å°‘åå¤è¿æ¥redisçš„æ¬¡æ•°
    - luaè„šæœ¬ç±»ä¼¼redisçš„äº‹åŠ¡ï¼Œæœ‰ä¸€å®šçš„åŸå­æ€§ï¼Œä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ’é˜Ÿ
    - åˆ©ç”¨luaè„šæœ¬æ·˜æ±°ç”¨æˆ·ï¼Œè§£å†³è¶…å–é—®é¢˜
    - é€šè¿‡luaè§£å†³äº‰æŠ¢é—®é¢˜ï¼Œå®é™…ä¸Šæ˜¯**redisåˆ©ç”¨å•çº¿ç¨‹çš„ç‰¹æ€§ï¼Œç”¨ä»»åŠ¡é˜Ÿåˆ—çš„æ–¹å¼è§£å†³å¤šä»»åŠ¡å¹¶å‘é—®é¢˜**

### åˆ†å¸ƒå¼é”

> è¶…å–é—®é¢˜ï¼Œé¿å…ä¸€ä»¶å•†å“è¢«å¤šä¸ªäººä¿®æ”¹

ä¸šåŠ¡åˆ†æï¼š

- ä½¿ç”¨watchç›‘æ§ä¸€ä¸ªkeyæœ‰æ²¡æœ‰æ”¹å˜ä¸èƒ½è§£å†³é—®é¢˜ï¼Œéœ€è¦ç›‘æ§çš„æ˜¯å…·ä½“æ•°æ®
- è™½ç„¶redisæ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯**å¤šä¸ªå®¢æˆ·ç«¯å¯¹åŒä¸€æ•°æ®è¿›è¡Œæ“ä½œï¼Œå¦‚ä½•é¿å…ä¸è¢«åŒæ—¶ä¿®æ”¹ï¼Ÿ**

è§£å†³æ–¹æ¡ˆ

- **ä½¿ç”¨setnxè®¾ç½®ä¸€ä¸ªå…¬å…±é”**ï¼šåˆ©ç”¨setnxå‘½ä»¤è¿”å›å€¼ç‰¹å¾ï¼Œæœ‰å€¼å°±è¿”å›è®¾ç½®å¤±è´¥ï¼ˆæ— æ§åˆ¶æƒï¼‰ï¼Œæ— å€¼åˆ™è¿”å›è®¾ç½®æˆåŠŸï¼ˆæœ‰æ§åˆ¶æƒï¼‰ï¼Œæ“ä½œå®Œæ¯•é€šè¿‡delæ“ä½œé‡Šæ”¾é”

```sql
setnx lock-key value
```



> ä¸šåŠ¡åœºæ™¯
>
> ä¾èµ–åˆ†å¸ƒå¼é”çš„æœºåˆ¶ï¼ŒæŸä¸ªç”¨æˆ·æ“ä½œæ—¶å¯¹åº”å®¢æˆ·ç«¯å½“å³ï¼Œä¸”æ­¤æ—¶å·²ç»è·å–åˆ°é”ï¼Œå¦‚ä½•è§£å†³ï¼Ÿ

ä¸šåŠ¡åˆ†æï¼š

- ç”±äºé”æ“ä½œç”±ç”¨æˆ·æ§åˆ¶åŠ é”è§£é”ï¼Œå¿…å®šä¼šå­˜åœ¨åŠ é”åä¸è§£é”çš„é£é™©
- éœ€è¦è§£é”æ“ä½œä¸èƒ½ä»…ä¾èµ–ç”¨æˆ·æ§åˆ¶ï¼Œç³»ç»Ÿçº§åˆ«è¦ç»™å‡ºä¿åº•å¤„ç†æ–¹æ¡ˆ

è§£å†³æ–¹æ¡ˆ

- ä½¿ç”¨expireä¸ºé”keyæ·»åŠ æ—¶é—´é™åˆ¶

```sql
expire lock-key second
pexpire lock-key milliseconds
```

## 



## ğŸ˜Š æŒä¹…åŒ–

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210417214135821.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

> ä»€ä¹ˆæ˜¯æŒä¹…åŒ–ï¼Ÿ

æŒä¹…åŒ–ï¼šåˆ©ç”¨æ°¸ä¹…æ€§å­˜å‚¨ä»‹è´¨å°†æ•°æ®è¿›è¡Œä¿å­˜ï¼Œåœ¨ç‰¹å®šçš„æ—¶é—´å°†ä¿å­˜çš„æ•°æ®è¿›è¡Œæ¢å¤çš„å·¥ä½œæœºåˆ¶

> ä¸ºä»€ä¹ˆè¦è¿›è¡ŒæŒä¹…åŒ–ï¼Ÿ

é˜²æ­¢æ•°æ®çš„æ„å¤–ä¸¢å¤±ï¼Œç¡®ä¿æ•°æ®å®‰å…¨

> æŒä¹…åŒ–è¿‡ç¨‹ä¿å­˜ä»€ä¹ˆï¼Ÿ

1ã€RDBï¼šå°†å½“å‰æ•°æ®çŠ¶æ€è¿›è¡Œä¿å­˜ï¼Œ**å¿«ç…§å½¢å¼**ï¼Œå­˜å‚¨æ•°æ®ç»“æœï¼Œå­˜å‚¨æ ¼å¼ç®€å•ï¼Œå…³æ³¨ç‚¹åœ¨æ•°æ®

2ã€AOFï¼šå°†æ•°æ®çš„æ“ä½œè¿‡ç¨‹è¿›è¡Œä¿å­˜ï¼Œ**æ—¥å¿—å½¢å¼**ï¼Œå­˜å‚¨æ“ä½œè¿‡ç¨‹ï¼Œå­˜å‚¨æ ¼å¼å¤æ‚ï¼Œå…³æ³¨ç‚¹åœ¨æ•°æ®çš„æ“ä½œè¿‡ç¨‹

### RDB

> è°ï¼Ÿä»€ä¹ˆæ—¶é—´ï¼Ÿå¹²ä»€ä¹ˆäº‹æƒ…ï¼Ÿ

- è°ï¼šredisæ“ä½œè€…
- ä»€ä¹ˆæ—¶é—´ï¼šå³æ—¶
- å¹²ä»€ä¹ˆäº‹æƒ…ï¼šä¿å­˜æ•°æ®

#### saveã€bgsave

1ã€å‘½ä»¤ï¼š

```sql
save
```

<img src="https://img-blog.csdnimg.cn/20210417214829822.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

2ã€saveæŒ‡ä»¤ç›¸å…³é…ç½®

<img src="https://img-blog.csdnimg.cn/20210417214936359.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

3ã€saveå·¥ä½œåŸç†

**saveæŒ‡ä»¤ä¼šé˜»å¡å½“å‰RedisæœåŠ¡å™¨ï¼Œçº¿ä¸Šç¯å¢ƒä¸å»ºè®®ä½¿ç”¨**

> æ•°æ®é‡è¿‡å¤§ï¼Œå•çº¿ç¨‹æ‰§è¡Œæ–¹å¼é€ æˆæ•ˆç‡è¿‡ä½å¦‚ä½•å¤„ç†ï¼Ÿ

**åå°æ‰§è¡Œ**

- è°ï¼šä½¿ç”¨è€…
- ä»€ä¹ˆæ—¶é—´ï¼šåˆç†çš„æ—¶é—´
- å¹²ä»€ä¹ˆäº‹ï¼šä¿å­˜æ•°æ®

1ã€å‘½ä»¤

```sql
bgsave
```

2ã€ä½œç”¨

æ‰‹åŠ¨å¯åŠ¨åå°ä¿å­˜æ“ä½œï¼Œä½†æ˜¯ä¸æ˜¯ç«‹å³æ‰§è¡Œçš„

```sql
127.0.0.1:6379> bgsave                                                                    
Background saving started 
```

3ã€å·¥ä½œåŸç†

<img src="https://img-blog.csdnimg.cn/2021041722000451.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

**bgsaveæ˜¯é’ˆå¯¹saveé˜»å¡é—®é¢˜åšçš„ä¼˜åŒ–ï¼ŒRediså†…éƒ¨æ‰€æ¶‰åŠçš„RDBæ“ä½œéƒ½é‡‡ç”¨bgsaveæ–¹å¼**

#### è‡ªåŠ¨æ‰§è¡Œ

> åå¤æ‰§è¡Œä¿å­˜æŒ‡ä»¤ï¼Œå¿˜è®°äº†æ€ä¹ˆåŠï¼Ÿä¸çŸ¥é“æ•°æ®äº§ç”Ÿäº†å¤šå°‘å˜åŒ–ï¼Ÿä½•æ—¶ä¿å­˜ï¼Ÿ

**è‡ªåŠ¨æ‰§è¡Œ**

- è°ï¼šredisæœåŠ¡å™¨å‘èµ·æŒ‡ä»¤ï¼ˆåŸºäºæ¡ä»¶ï¼‰
- ä»€ä¹ˆæ—¶é—´ï¼šæ»¡è¶³æ¡ä»¶
- å¹²ä»€ä¹ˆäº‹æƒ…ï¼šä¿å­˜æ•°æ®

1ã€é…ç½®

```sql
save second changes
```

ä½œç”¨ï¼šæ»¡è¶³é™å®šæ—¶é—´èŒƒå›´å†…ï¼ˆsecondï¼‰keyçš„å˜åŒ–æ•°é‡è¾¾åˆ°æŒ‡å®šæ•°é‡ï¼ˆchangesï¼‰å³è¿›è¡ŒæŒä¹…åŒ–

2ã€å·¥ä½œåŸç†

4ã€åŸç†

<img src="https://img-blog.csdnimg.cn/20210417220936467.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

saveé…ç½®è¦æ ¹æ®å®é™…ä¸šåŠ¡è®¾ç½®ï¼Œéšæ„è®¾ç½®ä¼šå‡ºç°é—®é¢˜

ä½¿ç”¨çš„æ˜¯bgsave

#### å¯¹æ¯”

<img src="https://img-blog.csdnimg.cn/20210418100055166.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

#### ä¼˜ç‚¹å’Œç¼ºç‚¹

1ã€ä¼˜ç‚¹

- å­˜å‚¨æ•ˆç‡é«˜
- å†…éƒ¨å­˜å‚¨çš„æ˜¯redisåœ¨æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®å¿«ç…§
- **é€Ÿåº¦æ¯”AOFå¿«**
- åº”ç”¨ï¼šæœåŠ¡å™¨ä¸­æ¯Xä¸ªå°æ—¶æ‰§è¡Œbgsaveå¤‡ä»½ï¼Œå°†rdbæ–‡ä»¶æ‹·è´åˆ°è¿œç¨‹æœºå™¨ä¸­ï¼Œ**ç”¨äºç¾éš¾æ¢å¤**

2ã€ç¼ºç‚¹

- æ— æ³•åšåˆ°å®æ—¶æŒä¹…åŒ–ï¼Œå…·æœ‰è¾ƒå¤§å¯èƒ½ä¸¢å¤±æ•°æ®
- bgsaveéœ€è¦forkæ“ä½œåˆ›å»ºå­è¿›ç¨‹ï¼Œè¦ç‰ºç‰²ä¸€äº›æ€§èƒ½
- redisä¼—å¤šç‰ˆæœ¬æ²¡æœ‰è¿›è¡Œrdbçš„æ ¼å¼ç»Ÿä¸€ï¼Œå¯èƒ½å‡ºç°å…¼å®¹é—®é¢˜

### AOF

> RDBçš„å¼Šç«¯ï¼š
>
> - æ•°æ®é‡å¤§ï¼Œæ•ˆç‡ä½ã€IOæ€§èƒ½ä½
> - åŸºäºforkåˆ›å»ºå­è¿›ç¨‹ï¼Œå†…å­˜äº§ç”Ÿé¢å¤–æ¶ˆè€—
> - å®•æœºå¸¦æ¥çš„æ•°æ®ä¸¢å¤±é£é™©
>
> è§£å†³æ€è·¯
>
> - ä¸å†™å…¨æ•°æ®ï¼Œä»…è®°å½•éƒ¨åˆ†æ•°æ®
> - æ”¹è®°å½•æ•°æ®ä¸ºè®°å½•æ“ä½œè¿‡ç¨‹
> - å¯¹æ‰€æœ‰æ“ä½œå‡è¿›è¡Œè®°å½•ï¼Œæ’é™¤ä¸¢å¤±æ•°æ®çš„é£é™©

1ã€AOFæ¦‚å¿µï¼šä»¥ç‹¬ç«‹æ—¥å¿—çš„æ–¹å¼è®°å½•æ¯æ¬¡å†™å‘½ä»¤ï¼Œé‡å¯æ—¶å†é‡æ–°æ‰§è¡ŒAOFä¸­å‘½ä»¤æ¥æ¢å¤æ•°æ®ï¼Œä¸RDBç›¸æ¯”å¯ä»¥ç®€å•æè¿°ä¸º**æ”¹è®°å½•æ•°æ®ä¸ºè®°å½•æ“ä½œè¿‡ç¨‹**

2ã€ä¸»è¦ä½œç”¨ï¼šè§£å†³äº†æ•°æ®æŒä¹…åŒ–çš„å®æ—¶æ€§ï¼Œç›®å‰å·²ç»æ˜¯RedisæŒä¹…åŒ–çš„ä¸»æµæ–¹å¼

#### å†™æ•°æ®çš„è¿‡ç¨‹

<img src="https://img-blog.csdnimg.cn/20210418093029908.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

ä¸‰ä¸ªå†™æ•°æ®çš„ç­–ç•¥

- **always**ï¼šæ¯æ¬¡å†™å…¥æ“ä½œå‡åŒæ­¥åˆ°AOFæ–‡ä»¶ä¸­ï¼Œ**æ•°æ®é›¶è¯¯å·®ï¼Œæ€§èƒ½è¾ƒä½**
- **everysec**ï¼šæ¯ç§’å°†ç¼“å†²åŒºçš„æŒ‡ä»¤åŒæ­¥åˆ°AOFæ–‡ä»¶ä¸­ï¼Œæ•°æ®**å‡†ç¡®æ€§è¾ƒé«˜ï¼Œæ€§èƒ½è¾ƒé«˜**ï¼Œåœ¨ç³»ç»Ÿçªç„¶å®•æœºçš„æƒ…å†µä¸‹ä¸¢å¤±1sçš„æ•°æ®
- **no**ï¼šæ“ä½œç³»ç»Ÿæ§åˆ¶æ¯æ¬¡åŒæ­¥åˆ°AOFæ–‡ä»¶çš„å‘¨æœŸï¼Œ**è¿‡ç¨‹ä¸å¯æ§åˆ¶**

4ã€AOFåŠŸèƒ½å¼€å¯

- é…ç½®ï¼šå¼€å¯AOFæŒä¹…åŒ–åŠŸèƒ½

```sql
appendonly yes
```

- é…ç½®ï¼šAOFå†™æ•°æ®ç­–ç•¥

```sql
appendfsync always|everysec|no
```

#### AOFé‡å†™

éšç€å‘½ä»¤ä¸æ–­å†™å…¥AOFï¼Œæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRediså¼•å…¥äº†AOFé‡å†™æœºåˆ¶å‹ç¼©æ–‡ä»¶ä½“ç§¯ï¼ŒAOFæ–‡ä»¶é‡å†™æ˜¯å°†Redisè¿›ç¨‹å†…çš„æ•°æ®è½¬åŒ–ä¸ºå†™å‘½ä»¤åŒæ­¥åˆ°æ–°AOFæ–‡ä»¶çš„è¿‡ç¨‹ã€‚

**ç®€å•çš„è¯´ï¼Œå°±æ˜¯å°†åŒä¸€ä¸ªæ•°æ®çš„è‹¥å¹²æ‰§è¡Œç»“æœè½¬åŒ–ä¸ºæœ€ç»ˆç»“æœæ•°æ®å¯¹åº”çš„æŒ‡ä»¤è¿›è¡Œè®°å½•**

ä½œç”¨ï¼š

- é™ä½ç£ç›˜å ç”¨é‡
- æé«˜æŒä¹…åŒ–æ•ˆç‡
- é™ä½æ¢å¤æ•°æ®çš„æ•ˆç‡

è§„åˆ™ï¼š

- è¿›ç¨‹å†…å·²è¶…æ—¶çš„æ•°æ®ä¸å†å†™å…¥æ–‡ä»¶
- å¿½ç•¥æ— æ•ˆæŒ‡ä»¤ï¼Œé‡å†™æ—¶ä½¿ç”¨è¿›ç¨‹å†…æ•°æ®ç›´æ¥ç”Ÿæˆï¼Œæ–°çš„AOFåªä¿ç•™æœ€ç»ˆæ•°æ®çš„å†™å…¥å‘½ä»¤
- å¯¹åŒä¸€ä¸ªæ•°æ®çš„å¤šæ¡å‘½ä»¤è¿›è¡Œåˆå¹¶
- æŠŠrdbå¿«ç…§ä»¥äºŒè¿›åˆ¶çš„å½¢å¼é™„åœ¨æ–°çš„aofå¤´éƒ¨

æ–¹å¼ï¼š

- æ‰‹åŠ¨

```sql
bgrewriteaof
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210418094753542.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

- è‡ªåŠ¨ï¼ˆé…ç½®ï¼‰

```sql
auto-aof-rewrite-min-size size
auto-aof-rewrite-percentage percent
```

- è‡ªåŠ¨é‡å†™è§¦å‘å¯¹æ¯”å‚æ•°

```sql
aof_current_size
aof_base_size
```

- è‡ªåŠ¨é‡å†™è§¦å‘æ¡ä»¶

```sql
aof_current_size > auto-aof-rewrite-min-size
æˆ–è€…
(aof_current_size - aof_base_size) / aof_base_size >= auto-aof-rewrite-percentage
```

#### AOFå·¥ä½œæµç¨‹

<img src="https://img-blog.csdnimg.cn/20210418095341735.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />





![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210418095415457.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)





### RDBå’ŒAOFåŒºåˆ«

<img src="https://img-blog.csdnimg.cn/20210418095510742.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />



#### å¦‚ä½•é€‰æ‹©

**1ã€å¯¹æ•°æ®éå¸¸æ•æ„Ÿï¼Œå»ºè®®ä½¿ç”¨é»˜è®¤çš„AOFæŒä¹…åŒ–æ–¹æ¡ˆ**

- AOFæŒä¹…åŒ–ç­–ç•¥ä½¿ç”¨everysecondï¼Œæ¯ç§’é’Ÿfsyncä¸€æ¬¡ï¼Œè¯¥ç­–ç•¥redisä»å¯ä»¥ä¿æŒå¾ˆå¥½çš„å¤„ç†æ€§èƒ½ï¼Œå½“å‡ºç°é—®é¢˜ï¼Œæœ€å¤šä¸¢å¤±1sæ•°æ®
- æ³¨æ„ï¼šAOFæ–‡ä»¶å­˜å‚¨ä½“ç§¯å¤§ï¼Œä¸”æ¢å¤é€Ÿåº¦æ…¢

**2ã€æ•°æ®å‘ˆç°é˜¶æ®µæœ‰æ•ˆæ€§ï¼Œå»ºè®®ä½¿ç”¨RDBæŒä¹…åŒ–æ–¹æ¡ˆ**

- æ•°æ®å¯ä»¥è‰¯å¥½çš„åšåˆ°é˜¶æ®µå†…æ— ä¸¢å¤±ï¼Œä¸”æ¢å¤é€Ÿåº¦è¾ƒå¿«
- æ³¨æ„ï¼šåˆ©ç”¨RDBå®ç°ç´§å‡‘æ•°æ®æŒä¹…åŒ–ä¼šé™ä½Redisæ€§èƒ½

3ã€ç»¼åˆæ¯”å¯¹

- RDBå’ŒAOFæ˜¯ä¸€ç§æƒè¡¡
- **ä¸èƒ½æ‰¿å—åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œå¯¹ä¸šåŠ¡æ•°æ®æ•æ„Ÿï¼Œä½¿ç”¨AOF**
- **èƒ½å¤Ÿæ‰¿å—åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œä¸”è¿½æ±‚å¤§æ•°æ®é›†çš„æ¢å¤é€Ÿåº¦ï¼Œä½¿ç”¨RDB**
- **ç¾éš¾æ¢å¤ä½¿ç”¨RDB**
- åŒä¿é™©ç­–ç•¥ï¼ŒåŒæ—¶å¼€å¯RDBå’ŒAOFï¼Œé‡å¯åRedis**ä¼˜å…ˆä½¿ç”¨AOF**æ¢å¤æ•°æ®

### æŒä¹…åŒ–åº”ç”¨åœºæ™¯

<img src="https://img-blog.csdnimg.cn/20210418100351741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

ä¸éœ€è¦æŒä¹…åŒ–ï¼š1ã€3ã€4ã€9ã€12ï¼ˆé•¿æœŸï¼‰ã€15

æŒä¹…åŒ–ï¼š5ã€6ã€7ã€12ï¼ˆçŸ­æœŸï¼‰ã€13ã€16



## ğŸ˜Š åˆ é™¤ç­–ç•¥

### è¿‡æœŸæ•°æ®

Redisæ˜¯ä¸€ç§å†…å­˜çº§çš„æ•°æ®åº“ï¼Œæ‰€æœ‰æ•°æ®å‡å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜ä¸­çš„æ•°æ®å¯ä»¥é€šè¿‡TTLæŒ‡ä»¤è·å–å…¶çŠ¶æ€

- XXï¼šå…·æœ‰æ—¶æ•ˆæ€§çš„æ•°æ®
- -1ï¼šæ°¸ä¹…æœ‰æ•ˆçš„æ•°æ®
- -2ï¼š**å·²ç»è¿‡æœŸçš„æ•°æ®**æˆ–**è¢«åˆ é™¤çš„æ•°æ®**æˆ–**æœªå®šä¹‰çš„æ•°æ®**

### åˆ é™¤ç­–ç•¥

#### æ—¶æ•ˆæ€§æ•°æ®çš„å­˜å‚¨ç»“æ„

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210418111159381.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)



> åˆ é™¤ç­–ç•¥çš„ç›®æ ‡

åœ¨å†…å­˜å ç”¨å’Œcpuå ç”¨ä¹‹é—´å¯»æ‰¾å¹³è¡¡ç‚¹

#### å®šæ—¶åˆ é™¤

**1ã€åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œå½“keyè®¾ç½®æœ‰è¿‡æœŸæ—¶é—´ï¼Œä¸”è¿‡æœŸæ—¶é—´åˆ°è¾¾ï¼Œç”±å®šæ—¶å™¨ä»»åŠ¡ç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œ**

2ã€ä¼˜ç‚¹ï¼šèŠ‚çº¦å†…å­˜ï¼Œå¿«é€Ÿé‡Šæ”¾

3ã€ç¼ºç‚¹ï¼šcpuå‹åŠ›å¾ˆå¤§ï¼Œä¼šå½±å“redisæœåŠ¡å™¨çš„å“åº”æ—¶é•¿ã€ååé‡

4ã€æ€»ç»“ï¼šæ—¶é—´æ¢ç©ºé—´

#### æƒ°æ€§åˆ é™¤

**1ã€æ•°æ®åˆ°è¾¾è¿‡æœŸæ—¶é—´ä¸å¤„ç†ï¼Œç­‰ä¸‹æ¬¡è®¿é—®è¯¥æ•°æ®æ—¶å¦‚æœå·²ç»è¿‡æœŸå°±åˆ é™¤**

2ã€`expirelfNeeded()`ï¼šæ£€æŸ¥æ•°æ®è¿‡æœŸ

3ã€ä¼˜ç‚¹ï¼šèŠ‚çº¦cpuæ€§èƒ½

4ã€ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¾ˆå¤§ï¼Œå‡ºç°é•¿æœŸå ç”¨å†…å­˜çš„æ•°æ®

5ã€æ€»ç»“ï¼šå­˜å‚¨ç©ºé—´æ¢å¤„ç†å™¨æ€§èƒ½

#### å®šæœŸåˆ é™¤

1ã€è¿‡ç¨‹

- RedisæœåŠ¡å™¨åˆå§‹åŒ–æ—¶ï¼Œè¯»å–é…ç½®server.hzçš„å€¼ï¼Œé»˜è®¤ä¸º10ï¼›
- æ¯ç§’é’Ÿæ‰§è¡Œserver.hzæ¬¡`serverCron()->databasesCron()-> activeExpireCycle()`
- `activeExpireCycle()`å¯¹æ¯ä¸ªexpires[*]é€ä¸€æ£€æµ‹ï¼ŒéšæœºæŒ‘é€‰wä¸ªkeyæ£€æµ‹
  - å¦‚æœkeyè¶…æ—¶å°±åˆ é™¤
  - å¦‚æœä¸€è½®ä¸­åˆ é™¤çš„keyæ•°é‡>w * 0.25å¾ªç¯è¯¥è¿‡ç¨‹
  - å¦‚æœå°äºç­‰äºå°±æ£€æŸ¥ä¸‹ä¸€ä¸ªexpires[*]ï¼Œ0-15å¾ªç¯
  - wå€¼åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®

- å‚æ•°current_dbç”¨äºè®°å½•`activeExpireCycle()`è¿›å…¥å“ªä¸€ä¸ªexpires[*]æ‰§è¡Œ
- å¦‚æœ`activeExpireCycle()`æ‰§è¡Œæ—¶é—´åˆ°æœŸï¼Œä¸‹æ¬¡ä»current_å¯¹æ¯”ç»§ç»­æ‰§è¡Œ

**2ã€å‘¨æœŸæ€§è½®è¯¢redisåº“ä¸­çš„æ—¶æ•ˆæ€§æ•°æ®ï¼Œé‡‡ç”¨éšæœºæŠ½å–çš„ç­–ç•¥ï¼Œåˆ©ç”¨è¿‡æœŸæ•°æ®å æ¯”çš„æ–¹å¼æ§åˆ¶åˆ é™¤é¢‘ç‡**

3ã€ç‰¹ç‚¹ï¼š

- cpuæ€§èƒ½å ç”¨è®¾ç½®æœ‰å³°å€¼ï¼Œæ£€æµ‹é¢‘ç‡å¯ä»¥è‡ªå®šä¹‰è®¾ç½®
- å†…å­˜å‹åŠ›ä¸æ˜¯å¾ˆå¤§ï¼Œé•¿æœŸå ç”¨å†…å­˜çš„å†·æ•°æ®ä¼šè¢«æŒç»­æ¸…ç†

**4ã€æ€»ç»“ï¼šå‘¨æœŸæ€§æŠ½æŸ¥**

#### æ¯”å¯¹

**1ã€å®šæ—¶åˆ é™¤**

- å®šä¹‰è®¡æ—¶å™¨ï¼Œè¿‡æœŸå°±åˆ é™¤
- èŠ‚çº¦å†…å­˜ï¼Œæ— å ç”¨
- ä¸åˆ†æ—¶é—´å ç”¨cpu

**2ã€æƒ°æ€§åˆ é™¤**

- ä¸‹æ¬¡è®¿é—®å°±åˆ é™¤
- å†…å­˜å ç”¨ä¸¥é‡
- cpuåˆ©ç”¨ç‡é«˜

**3ã€å®šæœŸåˆ é™¤**

- è½®è¯¢redisåº“ï¼ŒéšæœºæŠ½æŸ¥
- æ¯ç§’èŠ±è´¹å›ºå®šçš„cpuèµ„æºç»´æŠ¤

### å†…å­˜æ·˜æ±°æœºåˆ¶

> å¦‚æœæ–°æ•°æ®è¿›å…¥redisæ—¶ï¼Œå¦‚æœå†…å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ

redisä½¿ç”¨å†…å­˜å­˜å‚¨æ•°æ®ï¼Œæ‰§è¡Œæ¯ä¸€ä¸ªå‘½ä»¤å‰ï¼Œä¼šè°ƒç”¨`freeMemoryifNeeded()`æ£€æµ‹å†…å­˜æ˜¯å¦å……è¶³

**å¦‚æœå†…å­˜ä¸æ»¡è¶³æ–°åŠ å…¥æ•°æ®çš„æœ€ä½å­˜å‚¨è¦æ±‚ï¼Œredisè¦ä¸´æ—¶åˆ é™¤ä¸€äº›æ•°æ®ï¼Œæ¸…ç†æ•°æ®çš„ç­–ç•¥ä¸ºé€å‡ºç®—æ³•**

#### é…ç½®

æœ€å¤§å¯ç”¨å†…å­˜

```sql
maxmemory
```

æ¯æ¬¡é€‰å–å¾…åˆ é™¤æ•°æ®ä¸ªæ•°

```sql
maxmemory-samples
```

åˆ é™¤ç­–ç•¥

```sql
maxmemory-policy
```

#### æ£€æµ‹æ˜“å¤±æ•°æ®

**å¯èƒ½ä¼šè¿‡æœŸçš„key**

- `voliate-lru`ï¼šæŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆæ—¶é—´ä¸Šï¼‰çš„æ•°æ®è¿›è¡Œæ•°æ®æ·˜æ±°ï¼ˆLRUï¼‰
- `voliate-lfu`ï¼šæŒ‘é€‰æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘ï¼ˆæ¬¡æ•°ä¸Šï¼‰çš„æ•°æ®æ·˜æ±°ï¼ˆLFUï¼‰
- `volatile-ttl`ï¼šæŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°
- `volatile-random`ï¼šä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°

#### æ£€æµ‹å…¨åº“æ•°æ®

**æ‰€æœ‰key**

- `allkeys-lru`
- `allkeys-lfu`
- `allkeys-random`ï¼šä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°

#### æ”¾å¼ƒæ•°æ®é©±é€

- `noenviction`ï¼šç¦æ­¢é©±é€

### LRUç®—æ³•

> æ˜¯ä»€ä¹ˆï¼Ÿ

Least Recently usedï¼Œ**å¸¸ç”¨é¡µé¢ç½®æ¢ç®—æ³•**

**é€‰æ‹©æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„æ•°æ®æ·˜æ±°**

https://leetcode-cn.com/problems/lru-cache/

**æ ¸å¿ƒï¼šå“ˆå¸Œé“¾è¡¨**

- æœ¬è´¨ï¼šHashMap+DoubleLinkedList

#### æ‰‹å†™LRU

```java
public class LRUCache{
  //NodeèŠ‚ç‚¹ä½œä¸ºæ•°æ®è½½ä½“
  class Node<k,v>{
    k key;
    v value;
    Node<k,v> prev;
    Node<k,v> next;
    public Node(){
      this.prev=this.next=null;
    }
    public Node(k key,v value){
      this.key=key;
      this.value=value;
      this.prev=this.next=null;
    }
  }

  //åŒå‘é“¾è¡¨ï¼Œé‡Œé¢æ”¾node
  class DoubleLinkedList<k,v>{
    Node<k,v> head;
    Node<k,v> tail;

    public DoubleLinkedList() {
      head=new Node<>();
      tail=new Node<>();
      head.next=tail;
      tail.prev=head;
    }
    //æ·»åŠ åˆ°å¤´
    public void addHead(Node<k,v> node){
      node.prev=head;
      node.next=tail.next;
      head.next.prev=node;
      head.next=node;
    }

    //åˆ é™¤èŠ‚ç‚¹
    public void removeNode(Node<k,v> node){
      node.next.prev=node.prev;
      node.prev.next=node.next;
      node.next=null;
      node.prev=null;
    }

    //è·å¾—æœ€åä¸€ä¸ªèŠ‚ç‚¹
    public Node<k,v> getLast(){
      return tail.prev;
    }
  }

  //ç¼“å­˜å‘ä½
  private int capacity;
  Map<Integer,Node<Integer,Integer>> map;
  DoubleLinkedList<Integer,Integer> doubleLinkedList;

  public LRUCache(int capacity){
    this.capacity=capacity;
    map=new HashMap<>();
    doubleLinkedList=new DoubleLinkedList<>();
  }

  public int get(int key){
    if(!map.containsKey(key)){
      return -1;
    }
    Node<Integer, Integer> node = map.get(key);
    doubleLinkedList.removeNode(node);
    doubleLinkedList.addHead(node);
    return node.value;
  }

  public void put(int key,int value){
    if(map.containsKey(key)){
      Node<Integer, Integer> node = map.get(key);
      node.value=value;
      map.put(key,node);
      doubleLinkedList.removeNode(node);
      doubleLinkedList.addHead(node);
    }else {
      if(map.size()==capacity){
        Node<Integer, Integer> last = doubleLinkedList.getLast();
        map.remove(last.key);
        doubleLinkedList.removeNode(last);
      }else {
        Node<Integer,Integer> newNode = new Node<>(key,value);
        map.put(key,newNode);
        doubleLinkedList.addHead(newNode);
      }
    }

  }
}
```

## ğŸ˜Š ä¸»ä»å¤åˆ¶

1ã€æ˜¯ä»€ä¹ˆï¼Ÿ

- ä¸»æœºæ•°æ®æ›´æ–°åæ ¹æ®é…ç½®å’Œç­–ç•¥ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°å¤‡æœºçš„master/slaveræœºåˆ¶ï¼Œmasterä»¥å†™ä¸ºä¸»ï¼Œslaveä»¥è¯»ä¸ºä¸»

<img src="https://img-blog.csdnimg.cn/de647e0d9da341d7a2e7d90aba4e7d67.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;" />

2ã€ç”¨å¤„

- è¯»å†™åˆ†ç¦»
- å®¹ç¾æ¢å¤

### ä¸»ä»å¤åˆ¶åŸç†

1ã€ä»æœåŠ¡å™¨è¿æ¥ä¸Šä¸»æœåŠ¡å™¨ä¹‹åï¼Œä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€è¿›è¡Œæ•°æ®åŒæ­¥æ¶ˆæ¯

2ã€ä¸»æœåŠ¡å™¨æ¥åˆ°ä»æœåŠ¡å™¨å‘é€è¿‡æ¥çš„åŒæ­¥æ¶ˆæ¯ä¹‹åï¼ŒæŠŠä¸»æœåŠ¡å™¨æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ï¼Œrdbæ–‡ä»¶ï¼ŒæŠŠrdbæ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨è¯»å–rdbæ–‡ä»¶

3ã€æ¯æ¬¡ä¸»æœåŠ¡å™¨è¿›è¡Œå†™æ“ä½œåï¼Œå’Œä»æœåŠ¡å™¨è¿›è¡Œæ•°æ®åŒæ­¥

### å“¨å…µæ¨¡å¼

> èƒ½å¤Ÿåå°ç›‘æ§ä¸»æœºæ˜¯å¦æ•…éšœï¼Œå¦‚æœæ•…éšœäº†æ ¹æ®æŠ•ç¥¨æ•°é‡è‡ªåŠ¨å°†ä»åº“è½¬æ¢ä¸ºä¸»åº“

<img src="https://img-blog.csdnimg.cn/5525ce7078a443c6a662aa90159176ab.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:33%;" />

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67310a227b284539810f3914ec1f3822~tplv-k3u1fbpfcp-watermark.awebp)

ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

- ä¸»èŠ‚ç‚¹ç”Ÿå­˜æ£€æµ‹
- ä¸»ä»æ“ä½œæ£€æµ‹
- è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼š**å½“ä¸»èŠ‚ç‚¹æ— æ³•æ­£å¸¸å·¥ä½œæ—¶ï¼ŒSentinelå°†å¯åŠ¨è‡ªåŠ¨æ•…éšœè½¬ç§»æ“ä½œã€‚å®ƒå°†ä¸å‘ç”Ÿæ•…éšœçš„ä¸»èŠ‚ç‚¹å¤„äºä¸»ä»å…³ç³»çš„ä»èŠ‚ç‚¹ä¹‹ä¸€å‡çº§åˆ°æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶ä»–ä»èŠ‚ç‚¹æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹ï¼›**
- ä¸»ä»åˆ‡æ¢

#### ç¼ºç‚¹ï¼šå¤åˆ¶å»¶æ—¶

ç”±äºæ‰€æœ‰çš„å†™æ“ä½œéƒ½æ˜¯å…ˆåœ¨masterä¸Šæ“ä½œï¼Œç„¶ååŒæ­¥æ›´æ–°åˆ°slaveä¸Šï¼Œæ‰€ä»¥ä»masteråŒæ­¥åˆ°slaveæœºå™¨æœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œå½“ç³»ç»Ÿå¾ˆç¹å¿™çš„æ—¶å€™ï¼Œå»¶è¿Ÿé—®é¢˜ä¼šæ›´åŠ ä¸¥é‡ï¼Œslaveæœºå™¨æ•°é‡çš„å¢åŠ ä¹Ÿä¼šä½¿è¿™ä¸ªé—®é¢˜æ›´åŠ ä¸¥é‡

#### æ•…éšœæ¢å¤

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/946cd9c3b9c1478aa55e5b0cfe359530.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

ä¼˜å…ˆçº§åœ¨redis.confä¸­é»˜è®¤ï¼Œslave-priority 100ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜

åç§»é‡æ˜¯æŒ‡è·å¾—ä¸»æœºæ•°æ®æœ€å…¨çš„

æ¯ä¸ªrediså®ä¾‹å¯åŠ¨åéƒ½ä¼šéšæœºäº§ç”Ÿrunid

## ğŸ˜Š Redisé›†ç¾¤

> é—®é¢˜ï¼š
>
> - å®¹é‡ä¸å¤Ÿï¼Œrediså¦‚ä½•è¿›è¡Œæ‰©å®¹ï¼Ÿ
> - å¹¶å‘å†™æ“ä½œï¼Œrediså¦‚ä½•åˆ†æ‘Šï¼Ÿ
>
> æ–¹æ³•ï¼šæ— ä¸­å¿ƒåŒ–é›†ç¾¤

**1ã€ä»€ä¹ˆæ˜¯é›†ç¾¤ï¼Ÿ**

- Redisé›†ç¾¤å®ç°äº†å¯¹Redisçš„æ°´å¹³æ‰©å®¹ï¼Œå³å¯åŠ¨Nä¸ªredisèŠ‚ç‚¹ï¼Œå°†æ•´ä¸ªæ•°æ®åº“åˆ†å¸ƒå­˜å‚¨åœ¨è¿™Nä¸ªèŠ‚ç‚¹ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨æ€»æ•°æ®çš„1/N



## ğŸ˜Š åº”ç”¨é—®é¢˜

### ç¼“å­˜ç©¿é€

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/d2193c72722a4411b4e39cbcbcdb4dd9.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

**1ã€èƒŒæ™¯**

- åº”ç”¨æœåŠ¡å™¨å‹åŠ›å˜å¤§äº†
- rediså‘½ä¸­ç‡é™ä½ï¼Œä¸€ç›´æŸ¥è¯¢æ•°æ®åº“

**2ã€ç°è±¡**

- redisæŸ¥è¯¢ä¸åˆ°æ•°æ®
- å‡ºç°å¤§é‡éæ­£å¸¸urlè®¿é—®

3ã€è§£å†³æ–¹æ¡ˆ

- **å¯¹ç©ºå€¼ç¼“å­˜ **ï¼šå¦‚æœä¸€ä¸ªæŸ¥è¯¢è¿”å›çš„æ•°æ®ä¸ºç©ºï¼ŒæŠŠè¿™ä¸ªç»“æœè¿›è¡Œç¼“å­˜
- **è®¾ç½®å¯è®¿é—®çš„ç™½åå•**ï¼šä½¿ç”¨bitmapså®šä¹‰ä¸€ä¸ªå¯è®¿é—®çš„åå•ï¼Œåå•idä½œä¸ºbitmapsçš„åç§»é‡ï¼Œæ¯æ¬¡è®¿é—®å’Œbitmapé‡Œé¢çš„idåšæ¯”è¾ƒ
- **é‡‡ç”¨å¸ƒéš†è¿‡æ»¤å™¨**

### ç¼“å­˜å‡»ç©¿

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/d493f2a1b9ce446f93571be04667c5db.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

**1ã€ç°è±¡**

- æ•°æ®åº“è®¿é—®å‹åŠ›ç¬é—´å¢åŠ 
- redisæ²¡æœ‰å‡ºç°å¤§é‡keyè¿‡æœŸ
- redisæ­£å¸¸è¿è¡Œ

**2ã€åŸå› **

- redisçš„æŸä¸ªkeyè¿‡æœŸï¼Œå¤§é‡è®¿é—®ä½¿ç”¨è¿™ä¸ªkey

**3ã€è§£å†³æ–¹æ¡ˆ**

- é¢„å…ˆè®¾ç½®çƒ­é—¨æ•°æ®
- äº‹æ—¶è°ƒæ•´ï¼šç›‘æ§çƒ­é—¨æ•°æ®ï¼Œå®æ—¶è°ƒæ•´keyçš„è¿‡æœŸæ—¶é•¿
- ä½¿ç”¨é”ï¼š
  - ç¼“å­˜å¤±æ•ˆçš„æ—¶å€™ï¼Œä¸æ˜¯ç«‹å³å»load db
  - å…ˆä½¿ç”¨ç¼“å­˜å·¥å…·çš„æŸäº›æˆåŠŸæ“ä½œè¿”å›å€¼çš„æ“ä½œï¼ˆredisçš„setnxï¼‰å»setä¸€ä¸ªmutex key
  - æ“ä½œè¿”å›æˆåŠŸæ—¶ï¼Œå†è¿›è¡Œload dbçš„æ“ä½œï¼Œå¹¶å›è®¾ç¼“å­˜ï¼Œåˆ é™¤mutex key
  - æ“ä½œè¿”å›å¤±è´¥ï¼Œè¯´æ˜æœ‰çº¿ç¨‹åœ¨load dbï¼Œå½“å‰çº¿ç¨‹ç¡çœ ä¸€æ®µæ—¶é—´é‡è¯•

### ç¼“å­˜é›ªå´©

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/2a01fe182c544e6f9558186e364e94b0.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjUwODk5,size_16,color_FFFFFF,t_70)

**1ã€ç°è±¡**

- æ•°æ®åº“å‹åŠ›å˜å¤§ï¼ŒæœåŠ¡å™¨å´©æºƒ
- å¤§é‡keyé›†ä¸­è¿‡æœŸ

2ã€è§£å†³æ–¹æ¡ˆ

- **æ„å»ºå¤šçº§ç¼“å­˜æ¶æ„**ï¼šngnixç¼“å­˜+redisç¼“å­˜+å…¶ä»–ç¼“å­˜
- **ä½¿ç”¨é”**ï¼šä¿è¯ä¸ä¼šæœ‰å¤§é‡çº¿ç¨‹å¯¹æ•°æ®åº“ä¸€æ¬¡æ€§è¿›è¡Œè¯»å†™ï¼Œä»è€Œé¿å…å¤±æ•ˆæ—¶å‡ºç°å¤§é‡å¹¶å‘è¯·æ±‚
- **è®¾ç½®è¿‡æœŸæ ‡å¿—æ›´æ–°ç¼“å­˜**ï¼šè®°å½•ç¼“å­˜æ•°æ®æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸä¼šè§¦å‘é€šçŸ¥å¦å¤–çš„çº¿ç¨‹åœ¨åå°æ›´æ–°å®é™…keyçš„ç¼“å­˜
- **åˆ†æ•£è¿‡æœŸæ—¶é—´**

### åˆ†å¸ƒå¼é”

1ã€ä½¿ç”¨setnxä¸Šé”ï¼Œä½¿ç”¨delé‡Šæ”¾é”

2ã€é”ä¸€ç›´æ²¡æœ‰é‡Šæ”¾ï¼Œè®¾ç½®keyçš„è¿‡æœŸæ—¶é—´ï¼Œè‡ªåŠ¨é‡Šæ”¾

```sql
setnx user 1
expire 10
```

3ã€ä¸Šé”ä¹‹åçªç„¶å‡ºç°å¼‚å¸¸ï¼Œæ— æ³•è®¾ç½®è¿‡æœŸæ—¶é—´

```sql
ä¸Šé”ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
set 10 nx ex 10
```















